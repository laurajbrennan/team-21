!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Chatkit=t()}(this,function(){"use strict";"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var e,t,n=(function(e,t){var n;"undefined"!=typeof self&&self,n=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=10)}([function(e,t,n){function r(e){var t={};if(!e)return t;for(var n=0,r=e.split("\r\n");n<r.length;n++){var o=r[n],i=o.indexOf(": ");if(i>0){var s=o.substring(0,i),a=o.substring(i+2);t[s]=a}}return t}Object.defineProperty(t,"__esModule",{value:!0}),t.responseToHeadersObject=r;var o=function(){function e(e,t,n){this.statusCode=e,this.headers=t,this.info=n}return e.fromXHR=function(t){var n=t.responseText;try{n=JSON.parse(t.responseText)}catch(e){}return new e(t.status,r(t.getAllResponseHeaders()),n)},e}();t.ErrorResponse=o;var i=function(){return function(e){this.error=e}}();t.NetworkError=i;var s=function(){return function(e){this.error=e}}();t.ProtocolError=s,function(e){e[e.UNSENT=0]="UNSENT",e[e.OPENED=1]="OPENED",e[e.HEADERS_RECEIVED=2]="HEADERS_RECEIVED",e[e.LOADING=3]="LOADING",e[e.DONE=4]="DONE"}(t.XhrReadyState||(t.XhrReadyState={}))},function(e,t,n){var r;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.VERBOSE=1]="VERBOSE",e[e.DEBUG=2]="DEBUG",e[e.INFO=3]="INFO",e[e.WARNING=4]="WARNING",e[e.ERROR=5]="ERROR"}(r=t.LogLevel||(t.LogLevel={}));var o=function(){function e(e){void 0===e&&(e=2),this.threshold=e;var t=Array(),n="--------------------------------------------------------------------------------";window.console.group||(window.console.group=function(e){t.push(e),window.console.log("%c \nBEGIN GROUP: %c",n,e)}),window.console.groupEnd||(window.console.groupEnd=function(){window.console.log("END GROUP: %c\n%c",t.pop(),n)})}return e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.log(window.console.log,r.VERBOSE,e)},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.log(window.console.log,r.DEBUG,e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.log(window.console.info,r.INFO,e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.log(window.console.warn,r.WARNING,e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.log(window.console.error,r.ERROR,e)},e.prototype.log=function(e,t,n){var o=this;if(t>=this.threshold){var i="Logger."+r[t];n.length>1?(window.console.group(),n.forEach(function(t){o.errorAwareLog(e,t,i)}),window.console.groupEnd()):this.errorAwareLog(e,n[0],i)}},e.prototype.errorAwareLog=function(e,t,n){if(null!=t&&t.info&&t.info.error_uri){var r=t.info.error_description;e((r||"An error has occurred")+". More information can be found at "+t.info.error_uri+". Error object: ",t)}else e(n+": ",t)},e}();t.ConsoleLogger=o;var i=function(){function e(){}return e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e}();t.EmptyLogger=i},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0);t.createRetryStrategyOptionsOrDefault=function(e){var t=e.initialTimeoutMillis||1e3,n=e.maxTimeoutMillis||5e3,r=-1;return void 0!==e.limit&&null!=e.limit&&(r=e.limit),{increaseTimeout:void 0!==e.increaseTimeout?e.increaseTimeout:function(e){return 2*e>n?n:2*e},initialTimeoutMillis:t,limit:r,maxTimeoutMillis:n}};var o=function(){return function(e){this.waitTimeMillis=e}}();t.Retry=o;var i=function(){return function(e){this.error=e}}();t.DoNotRetry=i;var s=function(){function e(e,t,n){this.options=e,this.logger=t,this.retryUnsafeRequests=n,this.currentRetryCount=0,this.initialTimeoutMillis=e.initialTimeoutMillis,this.maxTimeoutMillis=e.maxTimeoutMillis,this.limit=e.limit,this.increaseTimeoutFunction=e.increaseTimeout,this.currentBackoffMillis=this.initialTimeoutMillis}return e.prototype.attemptRetry=function(e){if(this.logger.verbose(this.constructor.name+": Error received",e),this.currentRetryCount>=this.limit&&this.limit>=0)return this.logger.verbose(this.constructor.name+": Retry count is over the maximum limit: "+this.limit),new i(e);if(null==e)return new o(this.calculateMillisToRetry());if(e instanceof r.ErrorResponse&&e.headers["Retry-After"])return this.logger.verbose(this.constructor.name+": Retry-After header is present, retrying in "+e.headers["Retry-After"]),new o(1e3*parseInt(e.headers["Retry-After"],10));if(this.retryUnsafeRequests)return new o(this.calculateMillisToRetry());switch(e.constructor){case r.ErrorResponse:var t=e.statusCode,n=e.headers["Request-Method"];return t>=500&&t<600&&("GET"===(s=(s=n).toUpperCase())||"HEAD"===s||"OPTIONS"===s||"SUBSCRIBE"===s)?(this.logger.verbose(this.constructor.name+": Encountered an error with status code "+t+" and request method "+n+", will retry"),new o(this.calculateMillisToRetry())):(this.logger.verbose(this.constructor.name+": Encountered an error with status code "+t+" and request method "+n+", will not retry",e),new i(e));case r.NetworkError:return this.logger.verbose(this.constructor.name+": Encountered a network error, will retry",e),new o(this.calculateMillisToRetry());case r.ProtocolError:return this.logger.verbose(this.constructor.name+": Encountered a protocol error, will retry",e),new o(this.calculateMillisToRetry());default:return this.logger.verbose(this.constructor.name+": Encountered an error, will retry",e),new o(this.calculateMillisToRetry())}var s},e.prototype.calculateMillisToRetry=function(){return this.currentBackoffMillis=this.increaseTimeoutFunction(this.currentBackoffMillis),this.logger.verbose(this.constructor.name+": Retrying in "+this.currentBackoffMillis+"ms"),this.currentBackoffMillis},e}();t.RetryResolution=s},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),i=n(4),s=n(5),a=n(6),u=n(11),c=n(12),h=n(7),l=n(13),d=n(14),f=n(8),p=function(){function e(e){this.options=e,this.host=e.host.replace(/(\/)+$/,"");var t=e.logger||new o.ConsoleLogger;this.logger=t,this.websocketTransport=new d.default(this.host,t),this.httpTransport=new l.default(this.host,e.encrypted),this.sdkProduct=e.sdkProduct||"unknown",this.sdkVersion=e.sdkVersion||"unknown",this.sdkLanguage=e.sdkLanguage||"javascript",this.sdkPlatform=navigator?"ReactNative"===navigator.product?"react-native":"web":"node"}return e.prototype.request=function(e,t){var n=this;return e.tokenProvider?e.tokenProvider.fetchToken(t).then(function(t){var n;return void 0!==e.headers?e.headers.Authorization="Bearer "+t:e.headers=((n={}).Authorization="Bearer "+t,n),e}).then(function(e){return n.makeRequest(e)}):this.makeRequest(e)},e.prototype.subscribeResuming=function(e,t,n,o,i,a){var l=c.replaceMissingListenersWithNoOps(n),d=u.subscribeStrategyListenersFromSubscriptionListeners(l),p=!1;return s.createResumingStrategy(o,h.createTokenProvidingStrategy(f.createTransportStrategy(e,this.websocketTransport,this.logger),this.logger,a),this.logger,i)({onEnd:d.onEnd,onError:d.onError,onEvent:d.onEvent,onOpen:function(e){p||(p=!0,d.onOpen(e)),l.onSubscribe()},onRetrying:d.onRetrying},r({},t,this.infoHeaders()))},e.prototype.subscribeNonResuming=function(e,t,n,o,i){var s=c.replaceMissingListenersWithNoOps(n),l=u.subscribeStrategyListenersFromSubscriptionListeners(s),d=!1;return a.createRetryingStrategy(o,h.createTokenProvidingStrategy(f.createTransportStrategy(e,this.websocketTransport,this.logger),this.logger,i),this.logger)({onEnd:l.onEnd,onError:l.onError,onEvent:l.onEvent,onOpen:function(e){d||(d=!0,l.onOpen(e)),s.onSubscribe()},onRetrying:l.onRetrying},r({},t,this.infoHeaders()))},e.prototype.infoHeaders=function(){return{"X-SDK-Language":this.sdkLanguage,"X-SDK-Platform":this.sdkPlatform,"X-SDK-Product":this.sdkProduct,"X-SDK-Version":this.sdkVersion}},e.prototype.makeRequest=function(e){var t=this;return i.executeNetworkRequest(function(){return t.httpTransport.request(r({},e,{headers:r({},e.headers,t.infoHeaders())}))},e).catch(function(e){throw t.logger.error(e),e})},e}();t.BaseClient=p},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0);function o(e,t,n){return e.onreadystatechange=function(){4===e.readyState&&(e.status>=200&&e.status<300?t(e.response):0!==e.status?n(r.ErrorResponse.fromXHR(e)):n(new r.NetworkError("No Connection")))},e}t.executeNetworkRequest=function(e,t){return new Promise(function(n,r){!function(e,t){t.json?e.send(JSON.stringify(t.json)):e.send(t.body)}(o(e(),n,r),t)})},t.sendRawRequest=function(e){return new Promise(function(t,n){var r=o(new window.XMLHttpRequest,t,n);if(r.withCredentials=Boolean(e.withCredentials),r.open(e.method.toUpperCase(),e.url,!0),e.headers)for(var i in e.headers)e.headers.hasOwnProperty(i)&&r.setRequestHeader(i,e.headers[i]);r.send(e.body)})}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(2);t.createResumingStrategy=function(e,t,n,r){var s=o.createRetryStrategyOptionsOrDefault(e),a=new o.RetryResolution(s,n);return function(e,r){return new i(n,r,t,e,a)}};var i=function(){return function(e,t,n,r,o){var i=this;this.unsubscribe=function(){i.state.unsubscribe()},this.onTransition=function(e){i.state=e},this.state=new s(this.onTransition,e,t,n,r,o)}}(),s=function(){function e(e,t,n,r,o,i,s){var c=this;this.onTransition=e,this.logger=t,this.headers=n,this.nextSubscribeStrategy=r,this.listeners=o,this.retryResolution=i,this.initialEventId=s;var l=s;t.verbose("ResumingSubscription: transitioning to OpeningSubscriptionState"),l&&(n["Last-Event-Id"]=l,t.verbose("ResumingSubscription: initialEventId is "+l)),this.underlyingSubscription=r({onEnd:function(n){e(new h(t,o,n))},onError:function(s){e(new u(s,e,t,n,o,r,i,l))},onEvent:function(e){l=e.eventId,o.onEvent(e)},onOpen:function(n){e(new a(t,n,o,c.underlyingSubscription,e))},onRetrying:o.onRetrying},n)}return e.prototype.unsubscribe=function(){this.onTransition(new c(this.logger)),null!=this.underlyingSubscription&&this.underlyingSubscription.unsubscribe()},e}(),a=function(){function e(e,t,n,r,o){this.logger=e,this.headers=t,this.listeners=n,this.underlyingSubscription=r,this.onTransition=o,e.verbose("ResumingSubscription: transitioning to OpenSubscriptionState"),n.onOpen(t)}return e.prototype.unsubscribe=function(){this.onTransition(new c(this.logger)),this.underlyingSubscription.unsubscribe()},e}(),u=function(){function e(e,t,n,i,s,u,c,d){var f=this;this.onTransition=t,this.logger=n,this.headers=i,this.listeners=s,this.nextSubscribeStrategy=u,this.retryResolution=c,this.timeout=-1,n.verbose("ResumingSubscription: transitioning to ResumingSubscriptionState");var p=function(e,i){s.onRetrying();var a,u=((a=e)instanceof r.ErrorResponse&&(a.headers["Request-Method"]="SUBSCRIBE"),c.attemptRetry(a));u instanceof o.Retry?f.timeout=window.setTimeout(function(){g(i)},u.waitTimeMillis):t(new l(n,s,e))},g=function(e){n.verbose("ResumingSubscription: trying to re-establish the subscription"),e&&(n.verbose("ResumingSubscription: lastEventId: "+e),i["Last-Event-Id"]=e),f.underlyingSubscription=u({onEnd:function(e){t(new h(n,s,e))},onError:function(e){p(e,d)},onEvent:function(e){d=e.eventId,s.onEvent(e)},onOpen:function(e){t(new a(n,e,s,f.underlyingSubscription,t))},onRetrying:s.onRetrying},i)};p(e,d)}return e.prototype.unsubscribe=function(){this.onTransition(new c(this.logger)),window.clearTimeout(this.timeout),null!=this.underlyingSubscription&&this.underlyingSubscription.unsubscribe()},e}(),c=function(){function e(e,t){this.logger=e,e.verbose("ResumingSubscription: transitioning to EndingSubscriptionState")}return e.prototype.unsubscribe=function(){throw new Error("Subscription is already ending")},e}(),h=function(){function e(e,t,n){this.logger=e,this.listeners=t,e.verbose("ResumingSubscription: transitioning to EndedSubscriptionState"),t.onEnd(n)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}(),l=function(){function e(e,t,n){this.logger=e,this.listeners=t,e.verbose("ResumingSubscription: transitioning to FailedSubscriptionState",n),t.onError(n)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}()},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(2);t.createRetryingStrategy=function(e,t,n){var r=o.createRetryStrategyOptionsOrDefault(e),s=new o.RetryResolution(r,n);return function(e,r){return new i(n,r,e,t,s)}};var i=function(){return function(e,t,n,r,o){var i=this;this.unsubscribe=function(){i.state.unsubscribe()},this.onTransition=function(e){i.state=e},this.state=new s(this.onTransition,e,t,n,r,o)}}(),s=function(){function e(e,t,n,r,o,i){var s=this;this.logger=t,this.headers=n,this.listeners=r,this.nextSubscribeStrategy=o,this.retryResolution=i,t.verbose("RetryingSubscription: transitioning to OpeningSubscriptionState"),this.underlyingSubscription=o({onEnd:function(n){return e(new c(t,r,n))},onError:function(s){return e(new a(s,e,t,n,r,o,i))},onEvent:r.onEvent,onOpen:function(n){return e(new u(t,r,n,s.underlyingSubscription,e))},onRetrying:r.onRetrying},n)}return e.prototype.unsubscribe=function(){throw this.underlyingSubscription.unsubscribe(),new Error("Method not implemented.")},e}(),a=function(){function e(e,t,n,i,s,a,l){var d=this;this.onTransition=t,this.logger=n,this.headers=i,this.listeners=s,this.nextSubscribeStrategy=a,this.retryResolution=l,this.timeout=-1,n.verbose("RetryingSubscription: transitioning to RetryingSubscriptionState");var f=function(e){s.onRetrying();var i,a=((i=e)instanceof r.ErrorResponse&&(i.headers["Request-Method"]="SUBSCRIBE"),l.attemptRetry(i));a instanceof o.Retry?d.timeout=window.setTimeout(function(){p()},a.waitTimeMillis):t(new h(n,s,e))},p=function(){n.verbose("RetryingSubscription: trying to re-establish the subscription");var e=a({onEnd:function(e){return t(new c(n,s,e))},onError:function(e){return f(e)},onEvent:s.onEvent,onOpen:function(r){t(new u(n,s,r,e,t))},onRetrying:s.onRetrying},i)};f(e)}return e.prototype.unsubscribe=function(){window.clearTimeout(this.timeout),this.onTransition(new c(this.logger,this.listeners))},e}(),u=function(){function e(e,t,n,r,o){this.logger=e,this.listeners=t,this.headers=n,this.underlyingSubscription=r,this.onTransition=o,e.verbose("RetryingSubscription: transitioning to OpenSubscriptionState"),t.onOpen(n)}return e.prototype.unsubscribe=function(){this.underlyingSubscription.unsubscribe(),this.onTransition(new c(this.logger,this.listeners))},e}(),c=function(){function e(e,t,n){this.logger=e,this.listeners=t,e.verbose("RetryingSubscription: transitioning to EndedSubscriptionState"),t.onEnd(n)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}(),h=function(){function e(e,t,n){this.logger=e,this.listeners=t,e.verbose("RetryingSubscription: transitioning to FailedSubscriptionState",n),t.onError(n)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}()},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0);t.createTokenProvidingStrategy=function(e,t,n){return n?function(r,i){return new o(t,r,i,n,e)}:e};var o=function(){function e(e,t,n,r,o){var a=this;this.logger=e,this.listeners=t,this.headers=n,this.tokenProvider=r,this.nextSubscribeStrategy=o,this.unsubscribe=function(){a.state.unsubscribe(),a.state=new s(a.logger)},this.state=new i(e,n,o),this.subscribe()}return e.prototype.subscribe=function(){var e=this;this.tokenProvider.fetchToken().then(function(t){var n=Object.assign({},e.listeners);e.state.subscribe(t,{onEnd:function(t){e.state=new s(e.logger),n.onEnd(t)},onError:function(r){e.isTokenExpiredError(r)?(e.tokenProvider.clearToken(t),e.subscribe()):(e.state=new s(e.logger),n.onError(r))},onEvent:e.listeners.onEvent,onOpen:e.listeners.onOpen})}).catch(function(t){e.logger.debug("TokenProvidingSubscription: error when fetching token:",t),e.state=new s(e.logger),e.listeners.onError(t)})},e.prototype.isTokenExpiredError=function(e){return e instanceof r.ErrorResponse&&401===e.statusCode&&"authentication/expired"===e.info},e}(),i=function(){function e(e,t,n){this.logger=e,this.headers=t,this.nextSubscribeStrategy=n,e.verbose("TokenProvidingSubscription: transitioning to ActiveState")}return e.prototype.subscribe=function(e,t){var n=this;this.putTokenIntoHeader(e),this.underlyingSubscription=this.nextSubscribeStrategy({onEnd:function(e){n.logger.verbose("TokenProvidingSubscription: subscription ended"),t.onEnd(e)},onError:function(e){n.logger.verbose("TokenProvidingSubscription: subscription errored:",e),t.onError(e)},onEvent:t.onEvent,onOpen:function(e){n.logger.verbose("TokenProvidingSubscription: subscription opened"),t.onOpen(e)},onRetrying:t.onRetrying},this.headers)},e.prototype.unsubscribe=function(){null!=this.underlyingSubscription&&this.underlyingSubscription.unsubscribe()},e.prototype.putTokenIntoHeader=function(e){this.headers.Authorization="Bearer "+e,this.logger.verbose("TokenProvidingSubscription: token fetched: "+e)},e}(),s=function(){function e(e){this.logger=e,e.verbose("TokenProvidingSubscription: transitioning to InactiveState")}return e.prototype.subscribe=function(e,t){this.logger.verbose("TokenProvidingSubscription: subscribe called in Inactive state; doing nothing")},e.prototype.unsubscribe=function(){this.logger.verbose("TokenProvidingSubscription: unsubscribe called in Inactive state; doing nothing")},e}()},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.createTransportStrategy=function(e,t,n){return function(n,r){return t.subscribe(e,n,r)}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.HOST_BASE="pusherplatform.io"},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(3);t.BaseClient=r.BaseClient;var o=n(9);t.HOST_BASE=o.HOST_BASE;var i=n(15);t.Instance=i.default;var s=n(1);t.ConsoleLogger=s.ConsoleLogger,t.EmptyLogger=s.EmptyLogger;var a=n(0);t.ErrorResponse=a.ErrorResponse,t.NetworkError=a.NetworkError,t.responseToHeadersObject=a.responseToHeadersObject,t.XhrReadyState=a.XhrReadyState;var u=n(4);t.executeNetworkRequest=u.executeNetworkRequest,t.sendRawRequest=u.sendRawRequest;var c=n(5);t.createResumingStrategy=c.createResumingStrategy;var h=n(2);t.createRetryStrategyOptionsOrDefault=h.createRetryStrategyOptionsOrDefault,t.DoNotRetry=h.DoNotRetry,t.Retry=h.Retry,t.RetryResolution=h.RetryResolution;var l=n(6);t.createRetryingStrategy=l.createRetryingStrategy;var d=n(7);t.createTokenProvidingStrategy=d.createTokenProvidingStrategy;var f=n(8);t.createTransportStrategy=f.createTransportStrategy,t.default={BaseClient:r.BaseClient,ConsoleLogger:s.ConsoleLogger,EmptyLogger:s.EmptyLogger,Instance:i.default}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.subscribeStrategyListenersFromSubscriptionListeners=function(e){return{onEnd:e.onEnd,onError:e.onError,onEvent:e.onEvent,onOpen:e.onOpen,onRetrying:e.onRetrying}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.replaceMissingListenersWithNoOps=function(e){return{onEnd:e.onEnd||function(e){},onError:e.onError||function(e){},onEvent:e.onEvent||function(e){},onOpen:e.onOpen||function(e){},onRetrying:e.onRetrying||function(){},onSubscribe:e.onSubscribe||function(){}}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r,o=n(0);!function(e){e[e.UNOPENED=0]="UNOPENED",e[e.OPENING=1]="OPENING",e[e.OPEN=2]="OPEN",e[e.ENDING=3]="ENDING",e[e.ENDED=4]="ENDED"}(r=t.HttpTransportState||(t.HttpTransportState={}));var i=function(){function e(e,t){var n=this;return this.gotEOS=!1,this.lastNewlineIndex=0,this.state=r.UNOPENED,this.xhr=e,this.listeners=t,this.xhr.onreadystatechange=function(){switch(n.xhr.readyState){case o.XhrReadyState.UNSENT:case o.XhrReadyState.OPENED:case o.XhrReadyState.HEADERS_RECEIVED:n.assertStateIsIn(r.OPENING);break;case o.XhrReadyState.LOADING:n.onLoading();break;case o.XhrReadyState.DONE:n.onDone()}},this.state=r.OPENING,this.xhr.send(),this}return e.prototype.unsubscribe=function(){this.state=r.ENDED,this.xhr.abort(),this.listeners.onEnd&&this.listeners.onEnd(null)},e.prototype.onLoading=function(){if(this.assertStateIsIn(r.OPENING,r.OPEN,r.ENDING),200===this.xhr.status){this.state===r.OPENING&&(this.state=r.OPEN,this.listeners.onOpen&&this.listeners.onOpen(o.responseToHeadersObject(this.xhr.getAllResponseHeaders()))),this.assertStateIsIn(r.OPEN);var e=this.onChunk();this.assertStateIsIn(r.OPEN,r.ENDING),e&&(this.state=r.ENDED,e instanceof o.ErrorResponse&&204!==e.statusCode&&this.listeners.onError&&this.listeners.onError(e))}},e.prototype.onDone=function(){if(200===this.xhr.status){this.state===r.OPENING&&(this.state=r.OPEN,this.listeners.onOpen&&this.listeners.onOpen(o.responseToHeadersObject(this.xhr.getAllResponseHeaders()))),this.assertStateIsIn(r.OPEN,r.ENDING);var e=this.onChunk();e?(this.state=r.ENDED,204===e.statusCode?this.listeners.onEnd&&this.listeners.onEnd(null):this.listeners.onError&&this.listeners.onError(e)):this.state<=r.ENDING?this.listeners.onError&&this.listeners.onError(new Error("HTTP response ended without receiving EOS message")):this.listeners.onEnd&&this.listeners.onEnd(null)}else{if(this.assertStateIsIn(r.OPENING,r.OPEN,r.ENDED),this.state===r.ENDED)return;0===this.xhr.status?this.listeners.onError&&this.listeners.onError(new o.NetworkError("Connection lost.")):this.listeners.onError&&this.listeners.onError(o.ErrorResponse.fromXHR(this.xhr))}},e.prototype.onChunk=function(){this.assertStateIsIn(r.OPEN);var e=this.xhr.responseText,t=e.lastIndexOf("\n");if(t>this.lastNewlineIndex){var n=e.slice(this.lastNewlineIndex,t).split("\n");this.lastNewlineIndex=t;for(var o=0,i=n;o<i.length;o++){var s=i[o];if(0!==s.length){var a=JSON.parse(s),u=this.onMessage(a);if(null!=u)return u}}}},e.prototype.assertStateIsIn=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(!t.some(function(t){return t===e.state})){var o=t.map(function(e){return r[e]}).join(", "),i=r[this.state];window.console.warn("Expected this.state to be one of ["+o+"] but it is "+i)}},e.prototype.onMessage=function(e){switch(this.assertStateIsIn(r.OPEN),this.verifyMessage(e),e[0]){case 0:return null;case 1:return this.onEventMessage(e);case 255:return this.onEOSMessage(e);default:return new Error("Unknown Message: "+JSON.stringify(e))}},e.prototype.onEventMessage=function(e){if(this.assertStateIsIn(r.OPEN),4!==e.length)return new Error("Event message has "+e.length+" elements (expected 4)");e[0];var t=e[1],n=e[2],o=e[3];return"string"!=typeof t?new Error("Invalid event ID in message: "+JSON.stringify(e)):"object"!=typeof n||Array.isArray(n)?new Error("Invalid event headers in message: "+JSON.stringify(e)):(this.listeners.onEvent&&this.listeners.onEvent({body:o,headers:n,eventId:t}),null)},e.prototype.onEOSMessage=function(e){if(this.assertStateIsIn(r.OPEN),4!==e.length)return new Error("EOS message has "+e.length+" elements (expected 4)");e[0];var t=e[1],n=e[2],i=e[3];return"number"!=typeof t?new Error("Invalid EOS Status Code"):"object"!=typeof n||Array.isArray(n)?new Error("Invalid EOS ElementsHeaders"):(this.state=r.ENDING,new o.ErrorResponse(t,n,i))},e.prototype.verifyMessage=function(e){return this.gotEOS?new Error("Got another message after EOS message"):Array.isArray(e)?e.length<1?new Error("Message is empty array"):void 0:new Error("Message is not an array")},e}(),s=function(){function e(e,t){void 0===t&&(t=!0),this.baseURL=(t?"https":"http")+"://"+e}return e.prototype.request=function(e){return this.createXHR(this.baseURL,e)},e.prototype.subscribe=function(e,t,n){var r={headers:n,method:"SUBSCRIBE",path:e};return new i(this.createXHR(this.baseURL,r),t)},e.prototype.createXHR=function(e,t){var n=new window.XMLHttpRequest,r=e+"/"+t.path.replace(/^\/+/,"");if(n.open(t.method.toUpperCase(),r,!0),n=this.setJSONHeaderIfAppropriate(n,t),t.jwt&&n.setRequestHeader("authorization","Bearer "+t.jwt),t.headers)for(var o in t.headers)t.headers.hasOwnProperty(o)&&n.setRequestHeader(o,t.headers[o]);return n},e.prototype.setJSONHeaderIfAppropriate=function(e,t){return t.json&&e.setRequestHeader("content-type","application/json"),e},e}();t.default=s},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o,i=n(0);!function(e){e[e.Connecting=0]="Connecting",e[e.Open=1]="Open",e[e.Closing=2]="Closing",e[e.Closed=3]="Closed"}(o=t.WSReadyState||(t.WSReadyState={}));var s=function(){function e(){this.subscriptions={}}return e.prototype.add=function(e,t,n,r){return this.subscriptions[e]={headers:r,listeners:n,path:t},e},e.prototype.has=function(e){return void 0!==this.subscriptions[e]},e.prototype.isEmpty=function(){return 0===Object.keys(this.subscriptions).length},e.prototype.remove=function(e){return delete this.subscriptions[e]},e.prototype.get=function(e){return this.subscriptions[e]},e.prototype.getAll=function(){return this.subscriptions},e.prototype.getAllAsArray=function(){var e=this;return Object.keys(this.subscriptions).map(function(t){return r({subID:parseInt(t,10)},e.subscriptions[parseInt(t,10)])})},e.prototype.removeAll=function(){this.subscriptions={}},e}(),a=function(){function e(e,t){this.wsTransport=e,this.subID=t}return e.prototype.unsubscribe=function(){this.wsTransport.unsubscribe(this.subID)},e}(),u=function(){function e(e,t){this.webSocketPath="/ws",this.forcedClose=!1,this.closedError=null,this.lastSentPingID=null,this.baseURL="wss://"+e+this.webSocketPath,this.lastSubscriptionID=0,this.logger=t,this.subscriptions=new s,this.pendingSubscriptions=new s,this.connect()}return e.prototype.subscribe=function(e,t,n){this.tryReconnectIfNeeded();var r=this.lastSubscriptionID++;return this.socket.readyState!==o.Open?(this.pendingSubscriptions.add(r,e,t,n),new a(this,r)):(this.subscriptions.add(r,e,t,n),this.sendMessage(this.getMessage(100,r,e,n)),new a(this,r))},e.prototype.unsubscribe=function(e){this.sendMessage(this.getMessage(198,e));var t=this.subscriptions.get(e);t.listeners.onEnd&&t.listeners.onEnd(null),this.subscriptions.remove(e)},e.prototype.connect=function(){var e=this;this.forcedClose=!1,this.closedError=null,this.socket=new window.WebSocket(this.baseURL),this.socket.onopen=function(t){e.pendingSubscriptions.getAllAsArray().forEach(function(t){var n=t.subID,r=t.path,o=t.listeners,i=t.headers;e.subscribePending(r,o,i,n)}),e.pendingSubscriptions.removeAll(),e.pingInterval=window.setInterval(function(){if(!e.pongTimeout){var t=(new Date).getTime();1e4>t-e.lastMessageReceivedTimestamp||(e.sendMessage(e.getMessage(16,t)),e.lastSentPingID=t,e.pongTimeout=window.setTimeout(function(){1e4>(new Date).getTime()-e.lastMessageReceivedTimestamp?e.pongTimeout=null:e.close(new i.NetworkError("Pong response wasn't received within timeout"))},1e4))}},3e4)},this.socket.onmessage=function(t){return e.receiveMessage(t)},this.socket.onerror=function(t){e.logger.verbose("WebSocket encountered an error event",t)},this.socket.onclose=function(t){e.logger.verbose("WebSocket encountered a close event",t);var n=e.subscriptions.getAllAsArray().concat(e.pendingSubscriptions.getAllAsArray());e.subscriptions.removeAll(),e.pendingSubscriptions.removeAll(),n.forEach(function(t){t.listeners.onError&&t.listeners.onError(e.closedError)}),e.tryReconnectIfNeeded()}},e.prototype.close=function(e){if(this.socket instanceof window.WebSocket){var t=function(e){};null!=this.socket.onclose&&(t=this.socket.onclose.bind(this)),this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.onmessage=function(){},this.socket.onopen=function(){},this.forcedClose=!0,this.closedError=e,this.socket.close(),window.clearTimeout(this.pingInterval),window.clearTimeout(this.pongTimeout),this.pongTimeout=null,this.pingInterval=null,this.lastSentPingID=null,t()}},e.prototype.tryReconnectIfNeeded=function(){(this.forcedClose||this.socket.readyState===o.Closed)&&this.connect()},e.prototype.subscribePending=function(e,t,n,r){void 0!==r?(this.subscriptions.add(r,e,t,n),this.sendMessage(this.getMessage(100,r,e,n))):this.logger.debug("Subscription to path "+e+" has an undefined ID")},e.prototype.getMessage=function(e,t,n,r){return[e,t,n,r]},e.prototype.sendMessage=function(e){this.socket.readyState===o.Open?this.socket.send(JSON.stringify(e)):this.logger.warn("Can't send on socket in \""+o[this.socket.readyState]+'" state')},e.prototype.subscription=function(e){return this.subscriptions.get(e)},e.prototype.receiveMessage=function(e){var t;this.lastMessageReceivedTimestamp=(new Date).getTime();try{t=JSON.parse(e.data)}catch(t){return void this.close(new i.ProtocolError("Message is not valid JSON format. Getting "+e.data))}var n=this.validateMessage(t);if(n)this.close(n);else{var r=t.shift();switch(r){case 17:return void this.onPongMessage(t);case 16:return void this.onPingMessage(t);case 99:return void this.onCloseMessage(t)}var o=t.shift(),s=this.subscription(o);if(s){var a=s.listeners;switch(r){case 101:this.onOpenMessage(t,o,a);break;case 102:this.onEventMessage(t,a);break;case 199:this.onEOSMessage(t,o,a);break;default:this.close(new i.ProtocolError("Received unknown type of message."))}}else this.logger.debug("Received message for unknown subscription ID: "+o)}},e.prototype.validateMessage=function(e){return Array.isArray(e)?e.length<1?new i.ProtocolError("Message is empty array: "+JSON.stringify(e)):null:new i.ProtocolError("Message is expected to be an array. Getting: "+JSON.stringify(e))},e.prototype.onOpenMessage=function(e,t,n){n.onOpen&&n.onOpen(e[1])},e.prototype.onEventMessage=function(e,t){if(3===e.length){var n=e[0],r=e[1],o=e[2];"string"==typeof n?"object"!=typeof r||Array.isArray(r)?t.onError&&t.onError(new i.ProtocolError("Invalid event headers in message: "+JSON.stringify(e))):t.onEvent&&t.onEvent({eventId:n,headers:r,body:o}):t.onError&&t.onError(new i.ProtocolError("Invalid event ID in message: "+JSON.stringify(e)))}else t.onError&&t.onError(new i.ProtocolError("Event message has "+e.length+" elements (expected 4)"))},e.prototype.onEOSMessage=function(e,t,n){if(this.subscriptions.remove(t),3===e.length){var r=e[0],o=e[1],s=e[2];"number"==typeof r?"object"!=typeof o||Array.isArray(o)?n.onError&&n.onError(new i.ProtocolError("Invalid EOS ElementsHeaders")):204!==r?n.onError&&n.onError(new i.ErrorResponse(r,o,s)):n.onEnd&&n.onEnd(null):n.onError&&n.onError(new i.ProtocolError("Invalid EOS Status Code"))}else n.onError&&n.onError(new i.ProtocolError("EOS message has "+e.length+" elements (expected 4)"))},e.prototype.onCloseMessage=function(e){var t=e[0],n=e[1],r=e[2];if("number"==typeof t)if("object"!=typeof n||Array.isArray(n))this.close(new i.ProtocolError("Close message: Invalid EOS ElementsHeaders"));else{var o={error:r.error||"network_error",error_description:r.error_description||"Network error"};this.close(new i.ErrorResponse(t,n,o))}else this.close(new i.ProtocolError("Close message: Invalid EOS Status Code"))},e.prototype.onPongMessage=function(e){var t=e[0];this.lastSentPingID!==t&&this.close(new i.ProtocolError("Received pong with ID "+t+" but last sent ping ID was "+this.lastSentPingID)),window.clearTimeout(this.pongTimeout),delete this.pongTimeout,this.lastSentPingID=null},e.prototype.onPingMessage=function(e){var t=e[0];this.sendMessage(this.getMessage(17,t))},e}();t.default=u},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=n(9),i=n(1),s=function(){function e(e){if(!e.locator)throw new Error("Expected `locator` property in Instance options!");var t=e.locator.split(":");if(3!==t.length)throw new Error("The instance locator supplied is invalid. Did you copy it correctly from the Pusher dashboard?");if(!e.serviceName)throw new Error("Expected `serviceName` property in Instance options!");if(!e.serviceVersion)throw new Error("Expected `serviceVersion` property in Instance options!");this.platformVersion=t[0],this.cluster=t[1],this.id=t[2],this.serviceName=e.serviceName,this.serviceVersion=e.serviceVersion,this.host=e.host||this.cluster+"."+o.HOST_BASE,this.logger=e.logger||new i.ConsoleLogger,this.client=e.client||new r.BaseClient({encrypted:e.encrypted,host:this.host,logger:this.logger}),this.tokenProvider=e.tokenProvider}return e.prototype.request=function(e,t){return e.path=this.absPath(e.path),null!=e.headers&&void 0!==e.headers||(e.headers={}),e.tokenProvider=e.tokenProvider||this.tokenProvider,this.client.request(e,t)},e.prototype.subscribeNonResuming=function(e){var t=e.headers||{},n=e.retryStrategyOptions||{},r=e.tokenProvider||this.tokenProvider;return this.client.subscribeNonResuming(this.absPath(e.path),t,e.listeners,n,r)},e.prototype.subscribeResuming=function(e){var t=e.headers||{},n=e.retryStrategyOptions||{},r=e.tokenProvider||this.tokenProvider;return this.client.subscribeResuming(this.absPath(e.path),t,e.listeners,n,e.initialEventId,r)},e.prototype.absPath=function(e){return("/services/"+this.serviceName+"/"+this.serviceVersion+"/"+this.id+"/"+e).replace(/\/+/g,"/").replace(/\/+$/,"")},e}();t.default=s}])},e.exports=n()}(e={exports:{}},e.exports),e.exports);(t=n)&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")&&t.default;var r=n.BaseClient,o=n.HOST_BASE,i=n.Instance,s=n.sendRawRequest;function a(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function u(e){return function t(n){return 0===arguments.length||a(n)?t:e.apply(this,arguments)}}function c(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return a(n)?t:u(function(t){return e(n,t)});default:return a(n)&&a(r)?t:a(n)?u(function(t){return e(t,r)}):a(r)?u(function(t){return e(n,t)}):e(n,r)}}}function h(e,t){var n;e=e||[],t=t||[];var r=e.length,o=t.length,i=[];for(n=0;n<r;)i[i.length]=e[n],n+=1;for(n=0;n<o;)i[i.length]=t[n],n+=1;return i}function l(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,r){return t.apply(this,arguments)};case 4:return function(e,n,r,o){return t.apply(this,arguments)};case 5:return function(e,n,r,o,i){return t.apply(this,arguments)};case 6:return function(e,n,r,o,i,s){return t.apply(this,arguments)};case 7:return function(e,n,r,o,i,s,a){return t.apply(this,arguments)};case 8:return function(e,n,r,o,i,s,a,u){return t.apply(this,arguments)};case 9:return function(e,n,r,o,i,s,a,u,c){return t.apply(this,arguments)};case 10:return function(e,n,r,o,i,s,a,u,c,h){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function d(e,t,n){return function(){for(var r=[],o=0,i=e,s=0;s<t.length||o<arguments.length;){var u;s<t.length&&(!a(t[s])||o>=arguments.length)?u=t[s]:(u=arguments[o],o+=1),r[s]=u,a(u)||(i-=1),s+=1}return i<=0?n.apply(this,r):l(i,d(e,r,n))}}var f=c(function(e,t){return 1===e?u(t):l(e,d(e,[],t))});function p(e){return function t(n,r,o){switch(arguments.length){case 0:return t;case 1:return a(n)?t:c(function(t,r){return e(n,t,r)});case 2:return a(n)&&a(r)?t:a(n)?c(function(t,n){return e(t,r,n)}):a(r)?c(function(t,r){return e(n,t,r)}):u(function(t){return e(n,r,t)});default:return a(n)&&a(r)&&a(o)?t:a(n)&&a(r)?c(function(t,n){return e(t,n,o)}):a(n)&&a(o)?c(function(t,n){return e(t,r,n)}):a(r)&&a(o)?c(function(t,r){return e(n,t,r)}):a(n)?u(function(t){return e(t,r,o)}):a(r)?u(function(t){return e(n,t,o)}):a(o)?u(function(t){return e(n,r,t)}):e(n,r,o)}}}var g=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function v(e,t,n){return function(){if(0===arguments.length)return n();var r=Array.prototype.slice.call(arguments,0),o=r.pop();if(!g(o)){for(var i=0;i<e.length;){if("function"==typeof o[e[i]])return o[e[i]].apply(o,r);i+=1}if(function(e){return"function"==typeof e["@@transducer/step"]}(o))return t.apply(null,r)(o)}return n.apply(this,arguments)}}var m={init:function(){return this.xf["@@transducer/init"]()},result:function(e){return this.xf["@@transducer/result"](e)}},b=c(function(e,t){return t>e?t:e});function y(e,t){for(var n=0,r=t.length,o=Array(r);n<r;)o[n]=e(t[n]),n+=1;return o}function S(e){return"[object String]"===Object.prototype.toString.call(e)}var w=u(function(e){return!!g(e)||!!e&&("object"==typeof e&&(!S(e)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))}),k=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();function I(e){return new k(e)}var E=c(function(e,t){return l(e.length,function(){return e.apply(t,arguments)})});function R(e,t,n){for(var r=n.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=n.next()}return e["@@transducer/result"](t)}function T(e,t,n,r){return e["@@transducer/result"](n[r](E(e["@@transducer/step"],e),t))}var _="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function O(e,t,n){if("function"==typeof e&&(e=I(e)),w(n))return function(e,t,n){for(var r=0,o=n.length;r<o;){if((t=e["@@transducer/step"](t,n[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}(e,t,n);if("function"==typeof n["fantasy-land/reduce"])return T(e,t,n,"fantasy-land/reduce");if(null!=n[_])return R(e,t,n[_]());if("function"==typeof n.next)return R(e,t,n);if("function"==typeof n.reduce)return T(e,t,n,"reduce");throw new TypeError("reduce: list must be array or iterable")}var P=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=m.init,e.prototype["@@transducer/result"]=m.result,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}(),N=c(function(e,t){return new P(e,t)});function U(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var x=Object.prototype.toString,C=!{toString:null}.propertyIsEnumerable("toString"),M=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],A=function(){return arguments.propertyIsEnumerable("length")}(),j=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1},D=u("function"!=typeof Object.keys||A?function(e){if(Object(e)!==e)return[];var t,n,r=[],o=A&&function(){return"[object Arguments]"===x.call(arguments)?function(e){return"[object Arguments]"===x.call(e)}:function(e){return U("callee",e)}}(e);for(t in e)!U(t,e)||o&&"length"===t||(r[r.length]=t);if(C)for(n=M.length-1;n>=0;)U(t=M[n],e)&&!j(r,t)&&(r[r.length]=t),n-=1;return r}:function(e){return Object(e)!==e?[]:Object.keys(e)}),L=c(v(["fantasy-land/map","map"],N,function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return f(t.length,function(){return e.call(this,t.apply(this,arguments))});case"[object Object]":return O(function(n,r){return n[r]=e(t[r]),n},{},D(t));default:return y(e,t)}})),q=c(function(e,t){for(var n=t,r=0;r<e.length;){if(null==n)return;n=n[e[r]],r+=1}return n}),B=c(function(e,t){return q([e],t)}),H=p(O),V=c(function(e,t){return h(t,[e])}),F=u(function(e){for(var t=D(e),n=t.length,r=[],o=0;o<n;)r[o]=e[t[o]],o+=1;return r});var G=u(function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)});function J(e,t){return function(){return t.call(this,e.apply(this,arguments))}}function W(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return g(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,Array.prototype.slice.call(arguments,0,n-1))}}var z=p(W("slice",function(e,t,n){return Array.prototype.slice.call(n,e,t)})),X=u(W("tail",z(1,1/0)));function K(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return l(arguments[0].length,H(J,arguments[0],X(arguments)))}var Y=u(function(e){return S(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()});function $(){if(0===arguments.length)throw new Error("compose requires at least one argument");return K.apply(this,Y(arguments))}function Z(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}function Q(e,t,n){for(var r=0,o=n.length;r<o;){if(e(t,n[r]))return!0;r+=1}return!1}var ee=c(function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t});function te(e,t,n,r){var o=Z(e);function i(e,t){return ne(e,t,n.slice(),r.slice())}return!Q(function(e,t){return!Q(i,t,e)},Z(t),o)}function ne(e,t,n,r){if(ee(e,t))return!0;var o,i,s=G(e);if(s!==G(t))return!1;if(null==e||null==t)return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(s){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===(o=e.constructor,null==(i=String(o).match(/^function (\w*)/))?"":i[1]))return e===t;break;case"Boolean":case"Number":case"String":if(typeof e!=typeof t||!ee(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!ee(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var a=n.length-1;a>=0;){if(n[a]===e)return r[a]===t;a-=1}switch(s){case"Map":return e.size===t.size&&te(e.entries(),t.entries(),n.concat([e]),r.concat([t]));case"Set":return e.size===t.size&&te(e.values(),t.values(),n.concat([e]),r.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var u=D(e);if(u.length!==D(t).length)return!1;var c=n.concat([e]),h=r.concat([t]);for(a=u.length-1;a>=0;){var l=u[a];if(!U(l,t)||!ne(t[l],e[l],c,h))return!1;a-=1}return!0}var re=c(function(e,t){return ne(e,t,[],[])});function oe(e,t){return function(e,t,n){var r,o;if("function"==typeof e.indexOf)switch(typeof t){case"number":if(0===t){for(r=1/t;n<e.length;){if(0===(o=e[n])&&1/o===r)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(o=e[n])&&o!=o)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(re(e[n],t))return n;n+=1}return-1}(t,e,0)>=0}function ie(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'}var se=function(e){return(e<10?"0":"")+e},ae="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+se(e.getUTCMonth()+1)+"-"+se(e.getUTCDate())+"T"+se(e.getUTCHours())+":"+se(e.getUTCMinutes())+":"+se(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};var ue=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=m.init,e.prototype["@@transducer/result"]=m.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},e}(),ce=c(v(["filter"],c(function(e,t){return new ue(e,t)}),function(e,t){return n=t,"[object Object]"===Object.prototype.toString.call(n)?O(function(n,r){return e(t[r])&&(n[r]=t[r]),n},{},D(t)):function(e,t){for(var n=0,r=t.length,o=[];n<r;)e(t[n])&&(o[o.length]=t[n]),n+=1;return o}(e,t);var n})),he=c(function(e,t){return ce((n=e,function(){return!n.apply(this,arguments)}),t);var n});var le=u(function(e){return function e(t,n){var r=function(r){var o=n.concat([t]);return oe(r,o)?"<Circular>":e(r,o)},o=function(e,t){return y(function(t){return ie(t)+": "+r(e[t])},t.slice().sort())};switch(Object.prototype.toString.call(t)){case"[object Arguments]":return"(function() { return arguments; }("+y(r,t).join(", ")+"))";case"[object Array]":return"["+y(r,t).concat(o(t,he(function(e){return/^\d+$/.test(e)},D(t)))).join(", ")+"]";case"[object Boolean]":return"object"==typeof t?"new Boolean("+r(t.valueOf())+")":t.toString();case"[object Date]":return"new Date("+(isNaN(t.valueOf())?r(NaN):ie(ae(t)))+")";case"[object Null]":return"null";case"[object Number]":return"object"==typeof t?"new Number("+r(t.valueOf())+")":1/t==-1/0?"-0":t.toString(10);case"[object String]":return"object"==typeof t?"new String("+r(t.valueOf())+")":ie(t);case"[object Undefined]":return"undefined";default:if("function"==typeof t.toString){var i=t.toString();if("[object Object]"!==i)return i}return"{"+o(t,D(t)).join(", ")+"}"}}(e,[])}),de=c(oe),fe=c(W("forEach",function(e,t){for(var n=t.length,r=0;r<n;)e(t[r]),r+=1;return t})),pe=c(function(e,t){for(var n=D(t),r=0;r<n.length;){var o=n[r];e(t[o],o,t),r+=1}return t}),ge=c(U);function ve(e){return e}var me=u(ve),be=function(){function e(){this._nativeSet="function"==typeof Set?new Set:null,this._items={}}return e.prototype.add=function(e){return!ye(e,!0,this)},e.prototype.has=function(e){return ye(e,!1,this)},e}();function ye(e,t,n){var r,o=typeof e;switch(o){case"string":case"number":return 0===e&&1/e==-1/0?!!n._items["-0"]||(t&&(n._items["-0"]=!0),!1):null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):o in n._items?e in n._items[o]||(t&&(n._items[o][e]=!0),!1):(t&&(n._items[o]={},n._items[o][e]=!0),!1);case"boolean":if(o in n._items){var i=e?1:0;return!!n._items[o][i]||(t&&(n._items[o][i]=!0),!1)}return t&&(n._items[o]=e?[!1,!0]:[!0,!1]),!1;case"function":return null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):o in n._items?!!oe(e,n._items[o])||(t&&n._items[o].push(e),!1):(t&&(n._items[o]=[e]),!1);case"undefined":return!!n._items[o]||(t&&(n._items[o]=!0),!1);case"object":if(null===e)return!!n._items.null||(t&&(n._items.null=!0),!1);default:return(o=Object.prototype.toString.call(e))in n._items?!!oe(e,n._items[o])||(t&&n._items[o].push(e),!1):(t&&(n._items[o]=[e]),!1)}}var Se=c(function(e,t){for(var n,r,o=new be,i=[],s=0;s<t.length;)n=e(r=t[s]),o.add(n)&&i.push(r),s+=1;return i})(me),we=c(function(e,t){return f(e+1,function(){var n,r=arguments[e];if(null!=r&&(n=r[t],"[object Function]"===Object.prototype.toString.call(n)))return r[t].apply(r,Array.prototype.slice.call(arguments,0,e));throw new TypeError(le(r)+' does not have a method named "'+t+'"')})}),ke=we(1,"join");var Ie=c(function(e,t){return Array.prototype.slice.call(t,0).sort(e)}),Ee=we(1,"split"),Re=u(function(e){var t=[];for(var n in e)U(n,e)&&(t[t.length]=[n,e[n]]);return t}),Te="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff",_e=(String.prototype.trim,"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e}),Oe=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Pe=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),Ne=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},Ue=function(e,t){var n={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},xe=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),Ce=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},Me=K(ce(function(e){return void 0!==e}),Re,L(function(e){var t=xe(e,2),n=t[0],r=t[1];return n+"="+encodeURIComponent(r)}),ke("&")),Ae=function(e,t,n){var r=void 0===n?"undefined":_e(n);if(r!==t)throw new TypeError("expected "+e+" to be of type "+t+" but was of type "+r)},je=function(e,t){var n=void 0===t?"undefined":_e(t);if("string"!==n&&"function"!==n)throw new TypeError("expected "+e+" to be a string or function but was of type "+n)},De=function(e,t){var n=void 0===t?"undefined":_e(t);if("object"!==n&&"function"!==n)throw new TypeError("expected "+e+" to be an object or function but was of type "+n)},Le=function(e,t,n){if(!Array.isArray(n))throw new TypeError("expected "+e+" to be an array");n.forEach(function(n,r){return Ae(e+"["+r+"]",t,n)})},qe=function(e,t,n){Ae(e,"object",n),pe(function(n,r){return Ae(e+"."+r,t,n)},n)},Be=function(){return Math.floor(Date.now()/1e3)},He=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.url,r=t.queryParams,o=t.headers,i=t.withCredentials;Oe(this,e),je("url",n),r&&De("queryParams",r),o&&De("headers",o),this.url=n,this.queryParams=r,this.headers=o,this.withCredentials=i,this.fetchToken=this.fetchToken.bind(this),this.fetchFreshToken=this.fetchFreshToken.bind(this),this.cacheIsStale=this.cacheIsStale.bind(this),this.cache=this.cache.bind(this),this.clearCache=this.clearCache.bind(this),this.setUserId=this.setUserId.bind(this)}return Pe(e,[{key:"getValueOrFunction",value:function(e){return new Promise(function(t){t("function"==typeof e?e():e)})}},{key:"fetchToken",value:function(){var e=this;return this.cacheIsStale()?(this.req||this.fetchFreshToken()).then(function(t){var n=t.token,r=t.expiresIn;return e.cache(n,r),n}):Promise.resolve(this.cachedToken)}},{key:"fetchFreshToken",value:function(){var e=this;return this.req=Promise.all([this.getValueOrFunction(this.url),this.getValueOrFunction(this.queryParams),this.getValueOrFunction(this.headers)]).then(function(t){var n=xe(t,3),r=n[0],o=n[1],i=n[2];return s({method:"POST",url:function(e,t){return t+(de("?",t)?"&":"?")+Me(e)}(Ne({user_id:e.userId},o),r),body:Me({grant_type:"client_credentials"}),headers:Ne({"content-type":"application/x-www-form-urlencoded"},i),withCredentials:e.withCredentials})}).then(function(t){var n=JSON.parse(t),r=n.access_token,o=n.expires_in;return delete e.req,{token:r,expiresIn:o}}).catch(function(t){throw delete e.req,t}),this.req}},{key:"cacheIsStale",value:function(){return!this.cachedToken||Be()>this.cacheExpiresAt}},{key:"cache",value:function(e,t){this.cachedToken=e,this.cacheExpiresAt=Be()+t}},{key:"clearCache",value:function(){this.cachedToken=void 0,this.cacheExpiresAt=void 0}},{key:"setUserId",value:function(e){this.clearCache(),this.userId=e}}]),e}(),Ve=function(e){return{createdAt:e.created_at,createdByUserId:e.created_by_id,id:e.id,isPrivate:e.private,name:e.name,updatedAt:e.updated_at,customData:e.custom_data,deletedAt:e.deleted_at,unreadCount:e.unread_count,lastMessageAt:e.last_message_at}},Fe=function(e){return{avatarURL:e.avatar_url,createdAt:e.created_at,customData:e.custom_data,id:e.id,name:e.name,updatedAt:e.updated_at}},Ge=function(e){var t={roomId:e.room_id,id:e.id,senderId:e.user_id,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at};return e.parts?t.parts=e.parts.map(function(e){return ze(e)}):(t.text=e.text,e.attachment&&(t.attachment=We(e.attachment))),t},Je=function(e){return{position:e.position,updatedAt:e.updated_at,userId:e.user_id,roomId:e.room_id,type:e.cursor_type}},We=function(e){return{link:e.resource_link,type:e.type,name:e.name}},ze=function(e){if(null!=e.content)return{partType:"inline",payload:{type:e.type,content:e.content}};if(null!=e.url)return{partType:"url",payload:{type:e.type,url:e.url}};if(null!=e.attachment)return{partType:"attachment",payload:{type:e.type,name:e.attachment.name,size:e.attachment.size,customData:e.attachment.custom_data,_id:e.attachment.id,_downloadURL:e.attachment.download_url,_expiration:new Date(e.attachment.expiration)}};throw new TypeError("failed to parse message part")},Xe=function(){function e(t,n){Oe(this,e),this.avatarURL=t.avatarURL,this.createdAt=t.createdAt,this.customData=t.customData,this.id=t.id,this.name=t.name,this.updatedAt=t.updatedAt,this.presenceStore=n}return Pe(e,[{key:"presence",get:function(){return{state:this.presenceStore[this.id]||"unknown"}}}]),e}();function Ke(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,a=t.pending[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var u=s.value;n.push(u),t.inProgress.add(u)}}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return t.pending.clear(),e(n).then(function(e){var r=!0,o=!1,i=void 0;try{for(var s,a=n[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var u=s.value,c=!0,h=!1,l=void 0;try{for(var d,f=t.callbacks[u][Symbol.iterator]();!(c=(d=f.next()).done);c=!0){d.value.resolve(e)}}catch(e){h=!0,l=e}finally{try{!c&&f.return&&f.return()}finally{if(h)throw l}}t.inProgress.delete(u),delete t.callbacks[u]}}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}}).catch(function(e){var r=!0,o=!1,i=void 0;try{for(var s,a=n[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var u=s.value,c=!0,h=!1,l=void 0;try{for(var d,f=t.callbacks[u][Symbol.iterator]();!(c=(d=f.next()).done);c=!0){d.value.reject(e)}}catch(e){h=!0,l=e}finally{try{!c&&f.return&&f.return()}finally{if(h)throw l}}t.inProgress.delete(u),delete t.callbacks[u]}}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}})}var Ye=50,$e=250,Ze=2e4,Qe=function(){function e(t){var n,r,o,i,s=t.instance,a=t.presenceStore,u=t.logger;Oe(this,e),this.instance=s,this.presenceStore=a,this.logger=u,this.onSetHooks=[],this.users={},this.set=this.set.bind(this),this.get=this.get.bind(this),this.fetchMissingUser=(n=this._fetchMissingUserBatch.bind(this),r=Ye,o=$e,i={callbacks:{},pending:new Set,inProgress:new Set},function(e){return new Promise(function(t,s){i.pending.has(e)||i.inProgress.has(e)?i.callbacks[e].push({resolve:t,reject:s}):(i.pending.add(e),i.callbacks[e]=[{resolve:t,reject:s}]),i.pending.size>=o?(clearTimeout(i.timeout),Ke(n,i),delete i.timeout):i.timeout||(i.timeout=setTimeout(function(){Ke(n,i),delete i.timeout},r))})}),this.fetchMissingUsers=this.fetchMissingUsers.bind(this),this.fetchMissingUserReq=this.fetchMissingUserReq.bind(this),this.snapshot=this.snapshot.bind(this),this.getSync=this.getSync.bind(this),this.decorate=this.decorate.bind(this)}return Pe(e,[{key:"set",value:function(e){return this.users[e.id]=this.decorate(e),this.onSetHooks.forEach(function(t){return t(e.id)}),Promise.resolve(this.users[e.id])}},{key:"get",value:function(e){var t=this;return this.fetchMissingUser(e).then(function(){return t.users[e]})}},{key:"fetchMissingUsers",value:function(e){var t=this;return Promise.all(e.map(function(e){return t.fetchMissingUser(e)}))}},{key:"_fetchMissingUserBatch",value:function(e){var t=this,n=e.filter(function(e){return!t.users[e]});return n.length>0?this.fetchMissingUserReq(n):Promise.resolve()}},{key:"fetchMissingUserReq",value:function(e){var t,n,r,o,i,s=this;return this.instance.request({method:"GET",path:(t="id",n=e,r="/users_by_ids",o=de("?",r)?"":"?",i=L(function(e){return encodeURIComponent(t)+"="+encodeURIComponent(e)},n),r+o+ke("&",i))}).then(function(e){JSON.parse(e).map(function(e){return Fe(e)}).forEach(function(e){s.set(e)})}).catch(function(e){throw s.logger.warn("error fetching missing users:",e),e})}},{key:"snapshot",value:function(){return this.users}},{key:"getSync",value:function(e){return this.users[e]}},{key:"decorate",value:function(e){return e?new Xe(e,this.presenceStore):void 0}}]),e}(),et=function(){function e(t){var n=t.basicRoom,r=t.userStore,o=t.isSubscribedTo,i=t.logger;Oe(this,e),this.createdAt=n.createdAt,this.createdByUserId=n.createdByUserId,this.deletedAt=n.deletedAt,this.id=n.id,this.isPrivate=n.isPrivate,this.name=n.name,this.updatedAt=n.updatedAt,this.customData=n.customData,this.unreadCount=n.unreadCount,this.lastMessageAt=n.lastMessageAt,this.userIds=[],this.userStore=r,this.isSubscribedTo=o,this.logger=i,this.eq=this.eq.bind(this)}return Pe(e,[{key:"eq",value:function(e){return this.createdAt===e.createdAt&&this.createdByUserId===e.createdByUserId&&this.deletedAt===e.deletedAt&&this.id===e.id&&this.isPrivate===e.isPrivate&&this.name===e.name&&this.updatedAt===e.updatedAt&&JSON.stringify(this.customData)===JSON.stringify(e.customData)}},{key:"users",get:function(){var e=this;if(!this.isSubscribedTo(this.id)){var t=new Error("Must be subscribed to room "+this.id+" to access users property");throw this.logger.error(t),t}return ce(function(t){return de(t.id,e.userIds)},F(this.userStore.snapshot()))}}]),e}(),tt=function(){function e(t){Oe(this,e),this.instance=t.instance,this.userStore=t.userStore,this.isSubscribedTo=t.isSubscribedTo,this.logger=t.logger,this.rooms={},this.setSync=this.setSync.bind(this),this.set=this.set.bind(this),this.get=this.get.bind(this),this.popSync=this.popSync.bind(this),this.pop=this.pop.bind(this),this.addUserToRoom=this.addUserToRoom.bind(this),this.removeUserFromRoom=this.removeUserFromRoom.bind(this),this.updateSync=this.updateSync.bind(this),this.update=this.update.bind(this),this.fetchBasicRoom=this.fetchBasicRoom.bind(this),this.snapshot=this.snapshot.bind(this),this.getSync=this.getSync.bind(this),this.decorate=this.decorate.bind(this)}return Pe(e,[{key:"setSync",value:function(e){return this.rooms[e.id]||(this.rooms[e.id]=this.decorate(e)),this.rooms[e.id]}},{key:"set",value:function(e){return Promise.resolve(this.setSync(e))}},{key:"get",value:function(e){var t=this;return Promise.resolve(this.rooms[e]).then(function(n){return n||t.fetchBasicRoom(e).then(function(n){return t.set(e,n)})})}},{key:"popSync",value:function(e){var t=this.rooms[e];return delete this.rooms[e],t}},{key:"pop",value:function(e){return Promise.resolve(this.popSync(e))}},{key:"addUserToRoom",value:function(e,t){return Promise.all([this.get(e).then(function(e){return e.userIds=Se(V(t,e.userIds)),e}),this.userStore.fetchMissingUser(t)]).then(function(e){return xe(e,1)[0]})}},{key:"removeUserFromRoom",value:function(e,t){return this.get(e).then(function(e){return e.userIds=e.userIds.filter(function(e){return e!==t}),e})}},{key:"updateSync",value:function(e,t){var n=this.getSync(e);for(var r in t)n[r]=t[r];return n}},{key:"update",value:function(e,t){var n=this;return Promise.all([this.get(e).then(function(){return n.updateSync(e,t)}),this.userStore.fetchMissingUsers(t.userIds||[])]).then(function(e){return xe(e,1)[0]})}},{key:"fetchBasicRoom",value:function(e){var t=this;return this.instance.request({method:"GET",path:"/rooms/"+encodeURIComponent(e)}).then(K(JSON.parse,Ve)).catch(function(n){t.logger.warn("error fetching details for room "+e+":",n)})}},{key:"snapshot",value:function(){return this.rooms}},{key:"getSync",value:function(e){return this.rooms[e]}},{key:"decorate",value:function(e){return e?new et({basicRoom:e,userStore:this.userStore,isSubscribedTo:this.isSubscribedTo,logger:this.logger}):void 0}}]),e}(),nt=function(){function e(t,n,r){Oe(this,e),this.position=t.position,this.updatedAt=t.updatedAt,this.userId=t.userId,this.roomId=t.roomId,this.type=t.type,this.userStore=n,this.roomStore=r}return Pe(e,[{key:"user",get:function(){return this.userStore.getSync(this.userId)}},{key:"room",get:function(){return this.roomStore.getSync(this.roomId)}}]),e}(),rt=function(){function e(t){var n=t.instance,r=t.userStore,o=t.roomStore,i=t.logger;Oe(this,e),this.instance=n,this.userStore=r,this.roomStore=o,this.logger=i,this.cursors={},this.set=this.set.bind(this),this.get=this.get.bind(this),this.getSync=this.getSync.bind(this),this.fetchBasicCursor=this.fetchBasicCursor.bind(this),this.decorate=this.decorate.bind(this)}return Pe(e,[{key:"set",value:function(e){var t=this,n=ot(e.userId,e.roomId);return this.cursors[n]=this.decorate(e),this.userStore.fetchMissingUser(e.userId).then(function(){return t.cursors[n]})}},{key:"get",value:function(e,t){var n=this,r=ot(e,t);return this.cursors[r]?Promise.resolve(this.cursors[r]):this.fetchBasicCursor(e,t).then(function(e){return n.set(e)})}},{key:"getSync",value:function(e,t){return this.cursors[ot(e,t)]}},{key:"fetchBasicCursor",value:function(e,t){var n=this;return this.instance.request({method:"GET",path:"/cursors/0/rooms/"+encodeURIComponent(t)+"/users/"+encodeURIComponent(e)}).then(function(e){var t=JSON.parse(e);if(t)return Je(t)}).catch(function(e){throw n.logger.warn("error fetching cursor:",e),e})}},{key:"decorate",value:function(e){return e?new nt(e,this.userStore,this.roomStore):void 0}}]),e}(),ot=function(e,t){return encodeURIComponent(e)+"/"+encodeURIComponent(t)},it=function(){function e(t){var n=t.hooks,r=t.instance,o=t.logger;Oe(this,e),this.hooks=n,this.instance=r,this.logger=o,this.lastSentRequests={},this.timers={},this.sendThrottledRequest=this.sendThrottledRequest.bind(this),this.onIsTyping=this.onIsTyping.bind(this),this.onStarted=this.onStarted.bind(this),this.onStopped=this.onStopped.bind(this)}return Pe(e,[{key:"sendThrottledRequest",value:function(e){var t=this,n=Date.now(),r=this.lastSentRequests[e];return r&&n-r<1e3?Promise.resolve():(this.lastSentRequests[e]=n,this.instance.request({method:"POST",path:"/rooms/"+encodeURIComponent(e)+"/typing_indicators"}).catch(function(n){throw delete t.typingRequestSent[e],t.logger.warn("Error sending typing indicator in room "+e,n),n}))}},{key:"onIsTyping",value:function(e,t){var n=this;this.timers[e.id]||(this.timers[e.id]={}),this.timers[e.id][t.id]?clearTimeout(this.timers[e.id][t.id]):this.onStarted(e,t),this.timers[e.id][t.id]=setTimeout(function(){n.onStopped(e,t),delete n.timers[e.id][t.id]},1500)}},{key:"onStarted",value:function(e,t){this.hooks.global.onUserStartedTyping&&this.hooks.global.onUserStartedTyping(e,t),this.hooks.rooms[e.id]&&this.hooks.rooms[e.id].onUserStartedTyping&&this.hooks.rooms[e.id].onUserStartedTyping(t)}},{key:"onStopped",value:function(e,t){this.hooks.global.onUserStoppedTyping&&this.hooks.global.onUserStoppedTyping(e,t),this.hooks.rooms[e.id]&&this.hooks.rooms[e.id].onUserStoppedTyping&&this.hooks.rooms[e.id].onUserStoppedTyping(t)}}]),e}();function st(e){var t=e.basicCursors,n=e.cursorStore,r=e.onNewCursorHook;return Promise.all(t.map(function(e){var t=n.getSync(e.userId,e.roomId);if(!t||t.position!==e.position)return n.set(e).then(function(e){r&&r(e)})}))}var at=function(){function e(t){Oe(this,e),this.userId=t.userId,this.hooks=t.hooks,this.instance=t.instance,this.roomStore=t.roomStore,this.cursorStore=t.cursorStore,this.roomSubscriptions=t.roomSubscriptions,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.currentUser=t.currentUser,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onInitialState=this.onInitialState.bind(this),this.onAddedToRoom=this.onAddedToRoom.bind(this),this.onRemovedFromRoom=this.onRemovedFromRoom.bind(this),this.onRoomUpdated=this.onRoomUpdated.bind(this),this.onRoomDeleted=this.onRoomDeleted.bind(this)}return Pe(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,n){e.timeout=setTimeout(function(){n(new Error("user subscription timed out"))},e.connectionTimeout),e.onSubscriptionEstablished=function(n){clearTimeout(e.timeout),t(n)},e.sub=e.instance.subscribeNonResuming({path:"/users",listeners:{onError:function(t){clearTimeout(e.timeout),n(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling user subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"initial_state":this.onInitialState(t.data);break;case"added_to_room":this.onAddedToRoom(t.data);break;case"removed_from_room":this.onRemovedFromRoom(t.data);break;case"room_updated":this.onRoomUpdated(t.data);break;case"room_deleted":this.onRoomDeleted(t.data);break;case"new_cursor":this.onNewCursor(t.data)}}},{key:"onInitialState",value:function(e){var t=e.current_user,n=e.rooms,r=e.cursors,o=Fe(t),i=n.map(function(e){return Ve(e)}),s=r.map(function(e){return Je(e)});this.established?function(e){var t=e.basicUser,n=e.basicRooms,r=e.basicCursors,o=e.currentUser,i=e.roomStore,s=e.cursorStore,a=e.hooks;o.setPropertiesFromBasicUser(t);var u=!0,c=!1,h=void 0;try{for(var l,d=n[Symbol.iterator]();!(u=(l=d.next()).done);u=!0){var f=l.value,p=i.getSync(f.id);if(!p){var g=i.setSync(f);a.global.onAddedToRoom&&a.global.onAddedToRoom(g)}p&&!p.eq(f)&&(i.updateSync(f.id,f),a.global.onRoomUpdated&&a.global.onRoomUpdated(p))}}catch(e){c=!0,h=e}finally{try{!u&&d.return&&d.return()}finally{if(c)throw h}}var v=function(e){if(!n.some(function(t){return t.id===e})){var t=i.popSync(e);a.global.onRemovedFromRoom&&a.global.onRemovedFromRoom(t)}};for(var m in i.snapshot())v(m);st({basicCursors:r,cursorStore:s,onNewCursorHook:a.global.onNewReadCursor})}({basicUser:o,basicRooms:i,basicCursors:s,currentUser:this.currentUser,roomStore:this.roomStore,cursorStore:this.cursorStore,hooks:this.hooks}):(this.established=!0,this.onSubscriptionEstablished({basicUser:o,basicRooms:i,basicCursors:s}))}},{key:"onAddedToRoom",value:function(e){var t=this,n=e.room;this.roomStore.set(Ve(n)).then(function(e){t.hooks.global.onAddedToRoom&&t.hooks.global.onAddedToRoom(e)})}},{key:"onRemovedFromRoom",value:function(e){var t=this,n=e.room_id;this.roomStore.pop(n).then(function(e){e&&t.hooks.global.onRemovedFromRoom&&t.hooks.global.onRemovedFromRoom(e)})}},{key:"onRoomUpdated",value:function(e){var t=this,n=e.room,r=Ve(n);this.roomStore.update(r.id,r).then(function(e){t.hooks.global.onRoomUpdated&&t.hooks.global.onRoomUpdated(e)})}},{key:"onRoomDeleted",value:function(e){var t=this,n=e.room_id;this.roomStore.pop(n).then(function(e){e&&t.hooks.global.onRoomDeleted&&t.hooks.global.onRoomDeleted(e)})}},{key:"onNewCursor",value:function(e){var t=this;return this.cursorStore.set(Je(e)).then(function(e){t.hooks.global.onNewReadCursor&&0===e.type&&t.hooks.global.onNewReadCursor(e)})}}]),e}(),ut=function(){function e(t){Oe(this,e),this.userId=t.userId,this.instance=t.instance,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout}return Pe(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,n){e.timeout=setTimeout(function(){n(new Error("presence subscription timed out"))},e.connectionTimeout),e.sub=e.instance.subscribeNonResuming({path:"/users/"+encodeURIComponent(e.userId)+"/register",listeners:{onOpen:function(){clearTimeout(e.timeout),t()},onError:function(t){clearTimeout(e.timeout),n(t)}}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling presence subscription",e)}}}]),e}(),ct=function(){function e(t){Oe(this,e),this.userId=t.userId,this.hooks=t.hooks,this.instance=t.instance,this.userStore=t.userStore,this.roomStore=t.roomStore,this.presenceStore=t.presenceStore,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onPresenceState=this.onPresenceState.bind(this)}return Pe(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,n){e.timeout=setTimeout(function(){n(new Error("user presence subscription timed out"))},e.connectionTimeout),e.onSubscriptionEstablished=function(){clearTimeout(e.timeout),t()},e.sub=e.instance.subscribeNonResuming({path:"/users/"+encodeURIComponent(e.userId),listeners:{onError:function(t){clearTimeout(e.timeout),n(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling user presence subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"presence_state":this.onPresenceState(t.data)}}},{key:"onPresenceState",value:function(e){var t=this;this.onSubscriptionEstablished();var n=this.presenceStore[this.userId]||"unknown",r=function(e){return{state:["online","offline"].includes(e.state)?e.state:"unknown"}}(e).state;r!==n&&(this.presenceStore[this.userId]=r,this.userStore.get(this.userId).then(function(e){t.hooks.global.onPresenceChanged&&t.hooks.global.onPresenceChanged({current:r,previous:n},e),$(fe(function(o){var i=xe(o,2),s=i[0],a=i[1];return t.roomStore.get(s).then(function(t){de(e.id,t.userIds)&&a.onPresenceChanged({current:r,previous:n},e)})}),ce(function(e){return void 0!==e[1].onPresenceChanged}),Re)(t.hooks.rooms)}))}}]),e}(),ht=function(){function e(t){Oe(this,e),this.onNewCursorHook=t.onNewCursorHook,this.roomId=t.roomId,this.cursorStore=t.cursorStore,this.instance=t.instance,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onInitialState=this.onInitialState.bind(this),this.onNewCursor=this.onNewCursor.bind(this)}return Pe(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,n){e.timeout=setTimeout(function(){n(new Error("cursor subscription timed out"))},e.connectionTimeout),e.onSubscriptionEstablished=function(n){clearTimeout(e.timeout),t(n)},e.sub=e.instance.subscribeNonResuming({path:"/cursors/0/rooms/"+encodeURIComponent(e.roomId),listeners:{onError:function(t){clearTimeout(e.timeout),n(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling cursor subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"initial_state":this.onInitialState(t.data);break;case"new_cursor":this.onNewCursor(t.data)}}},{key:"onInitialState",value:function(e){var t=this,n=e.cursors.map(function(e){return Je(e)});this.established?st({basicCursors:n,cursorStore:this.cursorStore,onNewCursorHook:this.onNewCursorHook}):(this.established=!0,Promise.all(n.map(function(e){return t.cursorStore.set(e)})).then(this.onSubscriptionEstablished))}},{key:"onNewCursor",value:function(e){var t=this;return this.cursorStore.set(Je(e)).then(function(e){return t.onNewCursorHook(e)})}}]),e}(),lt=function(){function e(t,n,r){Oe(this,e),this.type=t.type,this.name=t.name,this.size=t.size,void 0!==t.customData&&(this.customData=t.customData),this._id=t._id,this._downloadURL=t._downloadURL,this._expiration=t._expiration,this._roomId=n,this._instance=r,this.url=this.url.bind(this),this.urlExpiry=this.urlExpiry.bind(this),this._fetchNewDownloadURL=this._fetchNewDownloadURL.bind(this)}return Pe(e,[{key:"url",value:function(){return this.urlExpiry().getTime()-Date.now()<18e5?this._fetchNewDownloadURL():Promise.resolve(this._downloadURL)}},{key:"urlExpiry",value:function(){return this._expiration}},{key:"_fetchNewDownloadURL",value:function(){var e=this;return this._instance.request({method:"GET",path:"rooms/"+encodeURIComponent(this._roomId)+"/attachments/"+this._id}).then(function(t){var n=JSON.parse(t),r=n.download_url,o=n.expiration;return e._downloadURL=r,e._expiration=new Date(o),e._downloadURL})}}]),e}(),dt=function(){function e(t,n,r,o){var i=this;Oe(this,e),this.id=t.id,this.senderId=t.senderId,this.roomId=t.roomId,this.createdAt=t.createdAt,this.updatedAt=t.updatedAt,this.deletedAt=t.deletedAt,t.parts?this.parts=t.parts.map(function(e){var t=e.partType,n=e.payload;return"attachment"===t?{partType:t,payload:new lt(n,i.roomId,o)}:{partType:t,payload:n}}):(this.text=t.text,t.attachment&&(this.attachment=t.attachment)),this.userStore=n,this.roomStore=r}return Pe(e,[{key:"sender",get:function(){return this.userStore.getSync(this.senderId)}},{key:"room",get:function(){return this.roomStore.getSync(this.roomId)}}]),e}(),ft=function(){function e(t){Oe(this,e),this.roomId=t.roomId,this.messageLimit=t.messageLimit,this.userId=t.userId,this.instance=t.instance,this.userStore=t.userStore,this.roomStore=t.roomStore,this.typingIndicators=t.typingIndicators,this.messageBuffer=[],this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.onMessageHook=t.onMessageHook,this.onMessageDeletedHook=t.onMessageDeletedHook,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onMessage=this.onMessage.bind(this),this.onMessageDeleted=this.onMessageDeleted.bind(this),this.flushBuffer=this.flushBuffer.bind(this),this.onIsTyping=this.onIsTyping.bind(this)}return Pe(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,n){e.timeout=setTimeout(function(){n(new Error("message subscription timed out"))},e.connectionTimeout),e.sub=e.instance.subscribeResuming({path:"/rooms/"+encodeURIComponent(e.roomId)+"?"+Me({message_limit:e.messageLimit}),listeners:{onOpen:function(){clearTimeout(e.timeout),t()},onError:function(t){clearTimeout(e.timeout),n(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling message subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"new_message":this.onMessage(t.data);break;case"message_deleted":this.onMessageDeleted(t.data);break;case"is_typing":this.onIsTyping(t.data)}}},{key:"onMessage",value:function(e){var t=this,n={message:new dt(Ge(e),this.userStore,this.roomStore,this.instance),ready:!1};this.messageBuffer.push(n),this.userStore.fetchMissingUser(n.message.senderId).catch(function(e){t.logger.error("error fetching missing user information:",e)}).then(function(){n.ready=!0,t.flushBuffer()})}},{key:"onMessageDeleted",value:function(e){this.onMessageDeletedHook(e.message_id)}},{key:"flushBuffer",value:function(){for(;this.messageBuffer.length>0&&this.messageBuffer[0].ready;)this.onMessageHook(this.messageBuffer.shift().message)}},{key:"onIsTyping",value:function(e){var t=this,n=e.user_id;n!==this.userId&&Promise.all([this.roomStore.get(this.roomId),this.userStore.get(n)]).then(function(e){var n=xe(e,2),r=n[0],o=n[1];return t.typingIndicators.onIsTyping(r,o)})}}]),e}(),pt=function(){function e(t){Oe(this,e),this.roomId=t.roomId,this.instance=t.instance,this.userStore=t.userStore,this.roomStore=t.roomStore,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.onUserJoinedRoomHook=t.onUserJoinedRoomHook,this.onUserLeftRoomHook=t.onUserLeftRoomHook,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onInitialState=this.onInitialState.bind(this),this.onUserJoined=this.onUserJoined.bind(this),this.onUserLeft=this.onUserLeft.bind(this)}return Pe(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,n){e.timeout=setTimeout(function(){n(new Error("membership subscription timed out"))},e.connectionTimeout),e.onSubscriptionEstablished=function(n){clearTimeout(e.timeout),t(n)},e.sub=e.instance.subscribeNonResuming({path:"/rooms/"+encodeURIComponent(e.roomId)+"/memberships",listeners:{onError:function(t){clearTimeout(e.timeout),n(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling membership subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"initial_state":this.onInitialState(t.data);break;case"user_joined":this.onUserJoined(t.data);break;case"user_left":this.onUserLeft(t.data)}}},{key:"onInitialState",value:function(e){var t=this,n=e.user_ids;this.established?function(e){var t=e.userIds,n=e.roomId,r=e.roomStore,o=e.userStore,i=e.onUserJoinedRoomHook,s=e.onUserLeftRoomHook;o.fetchMissingUsers(t).then(function(){var e=r.getSync(n);return t.filter(function(t){return!e.userIds.includes(t)}).forEach(function(t){return o.get(t).then(function(t){return i(e,t)})}),e.userIds.filter(function(e){return!t.includes(e)}).forEach(function(t){return o.get(t).then(function(t){return s(e,t)})}),r.update(n,{userIds:t})})}({userIds:n,roomId:this.roomId,roomStore:this.roomStore,userStore:this.userStore,onUserJoinedRoomHook:this.onUserJoinedRoomHook,onUserLeftRoomHook:this.onUserLeftRoomHook}):(this.established=!0,this.roomStore.update(this.roomId,{userIds:n}).then(function(){t.onSubscriptionEstablished()}))}},{key:"onUserJoined",value:function(e){var t=this,n=e.user_id;this.roomStore.addUserToRoom(this.roomId,n).then(function(e){return t.userStore.get(n).then(function(n){return t.onUserJoinedRoomHook(e,n)})})}},{key:"onUserLeft",value:function(e){var t=this,n=e.user_id;this.roomStore.removeUserFromRoom(this.roomId,n).then(function(e){return t.userStore.get(n).then(function(n){return t.onUserLeftRoomHook(e,n)})})}}]),e}(),gt=function(){function e(t){Oe(this,e),this.buffer=[],this.messageSub=new ft({roomId:t.roomId,messageLimit:t.messageLimit,userId:t.userId,instance:t.serverInstance,userStore:t.userStore,roomStore:t.roomStore,typingIndicators:t.typingIndicators,logger:t.logger,connectionTimeout:t.connectionTimeout,onMessageHook:this.bufferWhileConnecting(function(e){t.hooks.rooms[t.roomId]&&t.hooks.rooms[t.roomId].onMessage&&t.hooks.rooms[t.roomId].onMessage(e)}),onMessageDeletedHook:this.bufferWhileConnecting(function(e){t.hooks.rooms[t.roomId]&&t.hooks.rooms[t.roomId].onMessageDeleted&&t.hooks.rooms[t.roomId].onMessageDeleted(e)})}),this.cursorSub=new ht({roomId:t.roomId,cursorStore:t.cursorStore,instance:t.cursorsInstance,logger:t.logger,connectionTimeout:t.connectionTimeout,onNewCursorHook:this.bufferWhileConnecting(function(e){t.hooks.rooms[t.roomId]&&t.hooks.rooms[t.roomId].onNewReadCursor&&0===e.type&&e.userId!==t.userId&&t.hooks.rooms[t.roomId].onNewReadCursor(e)})}),this.membershipSub=new pt({roomId:t.roomId,instance:t.serverInstance,userStore:t.userStore,roomStore:t.roomStore,logger:t.logger,connectionTimeout:t.connectionTimeout,onUserJoinedRoomHook:this.bufferWhileConnecting(function(e,n){t.hooks.global.onUserJoinedRoom&&t.hooks.global.onUserJoinedRoom(e,n),t.hooks.rooms[e.id]&&t.hooks.rooms[e.id].onUserJoined&&t.hooks.rooms[e.id].onUserJoined(n)}),onUserLeftRoomHook:this.bufferWhileConnecting(function(e,n){t.hooks.global.onUserLeftRoom&&t.hooks.global.onUserLeftRoom(e,n),t.hooks.rooms[e.id]&&t.hooks.rooms[e.id].onUserLeft&&t.hooks.rooms[e.id].onUserLeft(n)})})}return Pe(e,[{key:"connect",value:function(){var e=this;return this.cancelled?Promise.reject(new Error("attempt to connect a cancelled room subscription")):Promise.all([this.messageSub.connect(),this.cursorSub.connect(),this.membershipSub.connect()]).then(function(){return e.flushBuffer()})}},{key:"cancel",value:function(){this.cancelled=!0,this.messageSub.cancel(),this.cursorSub.cancel(),this.membershipSub.cancel()}},{key:"bufferWhileConnecting",value:function(e){var t=this;return function(){for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];t.connected?e.apply(void 0,r):t.buffer.push(e.bind.apply(e,[t].concat(r)))}}},{key:"flushBuffer",value:function(){this.connected=!0,this.buffer.forEach(function(e){return e()}),delete this.buffer}}]),e}(),vt=function(){function e(t){Oe(this,e),this.onNotificationHook=t.onNotificationHook,this.userId=t.userId,this.instance=t.instance,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onNotification=this.onNotification.bind(this)}return Pe(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,n){e.timeout=setTimeout(function(){n(new Error("notification subscription timed out"))},e.connectionTimeout),e.sub=e.instance.subscribeNonResuming({path:"/users/"+encodeURIComponent(e.userId),listeners:{onOpen:function(){clearTimeout(e.timeout),t()},onError:function(t){clearTimeout(e.timeout),n(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling notification subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"push_notification":this.onNotification(t.data)}}},{key:"onNotification",value:function(e){this.onNotificationHook(e)}}]),e}();var mt=function(){function e(t){var n=this,r=t.serverInstanceV2,o=t.serverInstanceV6,i=t.connectionTimeout,s=t.cursorsInstance,a=t.filesInstance,u=t.hooks,c=t.id,h=t.presenceInstance,l=t.beamsTokenProviderInstance,d=t.pushNotificationsInstance,f=t.beamsInstanceInitFn;Oe(this,e),this.hooks={global:u,rooms:{}},this.id=c,this.encodedId=encodeURIComponent(this.id),this.serverInstanceV2=r,this.serverInstanceV6=o,this.filesInstance=a,this.cursorsInstance=s,this.connectionTimeout=i,this.presenceInstance=h,this.beamsTokenProviderInstance=l,this.pushNotificationsInstance=d,this.beamsInstanceInitFn=f,this.logger=o.logger,this.presenceStore={},this.userStore=new Qe({instance:this.serverInstanceV6,presenceStore:this.presenceStore,logger:this.logger}),this.roomStore=new tt({instance:this.serverInstanceV6,userStore:this.userStore,isSubscribedTo:function(e){return n.isSubscribedTo(e)},logger:this.logger}),this.cursorStore=new rt({instance:this.cursorsInstance,userStore:this.userStore,roomStore:this.roomStore,logger:this.logger}),this.typingIndicators=new it({hooks:this.hooks,instance:this.serverInstanceV6,logger:this.logger}),this.userStore.onSetHooks.push(function(e){return n.subscribeToUserPresence(e)}),this.roomSubscriptions={},this.readCursorBuffer={},this.userPresenceSubscriptions={},this.setReadCursor=this.setReadCursor.bind(this),this.readCursor=this.readCursor.bind(this),this.isTypingIn=this.isTypingIn.bind(this),this.createRoom=this.createRoom.bind(this),this.getJoinableRooms=this.getJoinableRooms.bind(this),this.joinRoom=this.joinRoom.bind(this),this.leaveRoom=this.leaveRoom.bind(this),this.addUserToRoom=this.addUserToRoom.bind(this),this.removeUserFromRoom=this.removeUserFromRoom.bind(this),this.sendMessage=this.sendMessage.bind(this),this.sendSimpleMessage=this.sendSimpleMessage.bind(this),this.sendMultipartMessage=this.sendMultipartMessage.bind(this),this.fetchMessages=this.fetchMessages.bind(this),this.fetchMultipartMessages=this.fetchMultipartMessages.bind(this),this.subscribeToRoom=this.subscribeToRoom.bind(this),this.subscribeToRoomMultipart=this.subscribeToRoomMultipart.bind(this),this.updateRoom=this.updateRoom.bind(this),this.deleteRoom=this.deleteRoom.bind(this),this.setReadCursorRequest=this.setReadCursorRequest.bind(this),this.uploadDataAttachment=this.uploadDataAttachment.bind(this),this.isMemberOf=this.isMemberOf.bind(this),this.isSubscribedTo=this.isSubscribedTo.bind(this),this.decorateMessage=this.decorateMessage.bind(this),this.setPropertiesFromBasicUser=this.setPropertiesFromBasicUser.bind(this),this.establishUserSubscription=this.establishUserSubscription.bind(this),this.establishPresenceSubscription=this.establishPresenceSubscription.bind(this),this.subscribeToUserPresence=this.subscribeToUserPresence.bind(this),this.disconnect=this.disconnect.bind(this),this._uploadAttachment=this._uploadAttachment.bind(this)}return Pe(e,[{key:"setReadCursor",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.roomId,r=t.position;return Ae("roomId","string",n),Ae("position","number",r),new Promise(function(t,o){void 0!==e.readCursorBuffer[n]?(e.readCursorBuffer[n].position=b(e.readCursorBuffer[n].position,r),e.readCursorBuffer[n].callbacks.push({resolve:t,reject:o})):(e.readCursorBuffer[n]={position:r,callbacks:[{resolve:t,reject:o}]},setTimeout(function(){e.setReadCursorRequest(Ne({roomId:n},e.readCursorBuffer[n])),delete e.readCursorBuffer[n]},500))})}},{key:"readCursor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.roomId,n=e.userId,r=void 0===n?this.id:n;if(Ae("roomId","string",t),Ae("userId","string",r),r!==this.id&&!this.isSubscribedTo(t)){var o=new Error("Must be subscribed to room "+t+" to access member's read cursors");throw this.logger.error(o),o}return this.cursorStore.getSync(r,t)}},{key:"isTypingIn",value:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).roomId;return Ae("roomId","string",e),this.typingIndicators.sendThrottledRequest(e)}},{key:"createRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.id,r=t.name,o=t.pushNotificationTitleOverride,i=t.addUserIds,s=t.customData,a=Ue(t,["id","name","pushNotificationTitleOverride","addUserIds","customData"]);return n&&Ae("id","string",n),r&&Ae("name","string",r),o&&Ae("pushNotificationTitleOverride","string",o),i&&Le("addUserIds","string",i),s&&Ae("customData","object",s),this.serverInstanceV6.request({method:"POST",path:"/rooms",json:{id:n,created_by_id:this.id,name:r,push_notification_title_override:o,private:!!a.private,user_ids:i,custom_data:s}}).then(function(t){return e.roomStore.set(Ve(JSON.parse(t)))}).catch(function(t){throw e.logger.warn("error creating room:",t),t})}},{key:"getJoinableRooms",value:function(){var e=this;return this.serverInstanceV6.request({method:"GET",path:"/users/"+this.encodedId+"/rooms?joinable=true"}).then(K(JSON.parse,L(Ve))).catch(function(t){throw e.logger.warn("error getting joinable rooms:",t),t})}},{key:"joinRoom",value:function(){var e=this,t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).roomId;return Ae("roomId","string",t),this.isMemberOf(t)?this.roomStore.get(t):this.serverInstanceV6.request({method:"POST",path:"/users/"+this.encodedId+"/rooms/"+encodeURIComponent(t)+"/join"}).then(function(t){return e.roomStore.set(Ve(JSON.parse(t)))}).catch(function(n){throw e.logger.warn("error joining room "+t+":",n),n})}},{key:"leaveRoom",value:function(){var e=this,t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).roomId;return Ae("roomId","string",t),this.roomStore.get(t).then(function(n){return e.serverInstanceV6.request({method:"POST",path:"/users/"+e.encodedId+"/rooms/"+encodeURIComponent(t)+"/leave"}).then(function(){return n})}).catch(function(n){throw e.logger.warn("error leaving room "+t+":",n),n})}},{key:"addUserToRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.userId,r=t.roomId;return Ae("userId","string",n),Ae("roomId","string",r),this.serverInstanceV6.request({method:"PUT",path:"/rooms/"+encodeURIComponent(r)+"/users/add",json:{user_ids:[n]}}).then(function(){return e.roomStore.addUserToRoom(r,n)}).catch(function(t){throw e.logger.warn("error adding user "+n+" to room "+r+":",t),t})}},{key:"removeUserFromRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.userId,r=t.roomId;return Ae("userId","string",n),Ae("roomId","string",r),this.serverInstanceV6.request({method:"PUT",path:"/rooms/"+encodeURIComponent(r)+"/users/remove",json:{user_ids:[n]}}).then(function(){return e.roomStore.removeUserFromRoom(r,n)}).catch(function(t){throw e.logger.warn("error removing user "+n+" from room "+r+":",t),t})}},{key:"sendMessage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.text,r=t.roomId,o=t.attachment;return Ae("text","string",n),Ae("roomId","string",r),new Promise(function(t,n){void 0!==o&&bt(o)?t(e.uploadDataAttachment(r,o)):void 0!==o&&yt(o)?t({resource_link:o.link,type:o.type}):void 0!==o?n(new TypeError("attachment was malformed")):t()}).then(function(t){return e.serverInstanceV2.request({method:"POST",path:"/rooms/"+encodeURIComponent(r)+"/messages",json:{text:n,attachment:t}})}).then(K(JSON.parse,B("message_id"))).catch(function(t){throw e.logger.warn("error sending message to room "+r+":",t),t})}},{key:"sendSimpleMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.roomId,n=e.text;return this.sendMultipartMessage({roomId:t,parts:[{type:"text/plain",content:n}]})}},{key:"sendMultipartMessage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.roomId,r=t.parts;return Ae("roomId","string",n),Le("parts","object",r),0===r.length?Promise.reject(new TypeError("message must contain at least one part")):Promise.all(r.map(function(t){return t.type=t.type||t.file&&t.file.type,Ae("part.type","string",t.type),t.content&&Ae("part.content","string",t.content),t.url&&Ae("part.url","string",t.url),t.name&&Ae("part.name","string",t.name),t.file&&Ae("part.file.size","number",t.file.size),t.file?e._uploadAttachment({roomId:n,part:t}):t})).then(function(t){return e.serverInstanceV6.request({method:"POST",path:"/rooms/"+encodeURIComponent(n)+"/messages",json:{parts:t.map(function(e){return{type:e.type,content:e.content,url:e.url,attachment:e.attachment}})}})}).then(function(e){return JSON.parse(e).message_id}).catch(function(t){throw e.logger.warn("error sending message to room "+n+":",t),t})}},{key:"fetchMessages",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.roomId,r=t.initialId,o=t.limit,i=t.direction,s=t.serverInstance;return Ae("roomId","string",n),r&&Ae("initialId","number",r),o&&Ae("limit","number",o),i&&function(e,t,n){if(!de(n,t))throw new TypeError("expected "+e+" to be one of "+t+" but was "+n)}("direction",["older","newer"],i),(s||this.serverInstanceV2).request({method:"GET",path:"/rooms/"+encodeURIComponent(n)+"/messages?"+Me({initial_id:r,limit:o,direction:i})}).then(function(t){var n=JSON.parse(t).map(function(t){return e.decorateMessage(Ge(t))});return e.userStore.fetchMissingUsers(Se(L(B("senderId"),n))).then(function(){return Ie(function(e,t){return e.id-t.id},n)})}).catch(function(t){throw e.logger.warn("error fetching messages from room "+n+":",t),t})}},{key:"fetchMultipartMessages",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.fetchMessages(Ne({},e,{serverInstance:this.serverInstanceV6}))}},{key:"subscribeToRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.roomId,r=t.hooks,o=void 0===r?{}:r,i=t.messageLimit,s=t.serverInstance;Ae("roomId","string",n),qe("hooks","function",o),!s&&o.onMessageDeleted&&this.logger.warn("`subscribeToRoom` does not support the `onMessageDeleted` hook. Please use `subscribeToRoomMultipart` instead."),i&&Ae("messageLimit","number",i),this.roomSubscriptions[n]&&this.roomSubscriptions[n].cancel(),this.hooks.rooms[n]=o;var a=new gt({serverInstance:s||this.serverInstanceV2,connectionTimeout:this.connectionTimeout,cursorStore:this.cursorStore,cursorsInstance:this.cursorsInstance,hooks:this.hooks,logger:this.logger,messageLimit:i,roomId:n,roomStore:this.roomStore,typingIndicators:this.typingIndicators,userId:this.id,userStore:this.userStore});return this.roomSubscriptions[n]=a,this.joinRoom({roomId:n}).then(function(e){return a.connect().then(function(){return e})}).catch(function(t){throw e.logger.warn("error subscribing to room "+n+":",t),t})}},{key:"subscribeToRoomMultipart",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.subscribeToRoom(Ne({},e,{serverInstance:this.serverInstanceV6}))}},{key:"updateRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.roomId,r=t.name,o=t.pushNotificationTitleOverride,i=t.customData,s=Ue(t,["roomId","name","pushNotificationTitleOverride","customData"]);return Ae("roomId","string",n),r&&Ae("name","string",r),o&&Ae("pushNotificationTitleOverride","string",o),s.private&&Ae("private","boolean",s.private),i&&Ae("customData","object",i),this.serverInstanceV6.request({method:"PUT",path:"/rooms/"+encodeURIComponent(n),json:{name:r,push_notification_title_override:o,private:s.private,custom_data:i}}).then(function(){}).catch(function(t){throw e.logger.warn("error updating room:",t),t})}},{key:"deleteRoom",value:function(){var e=this,t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).roomId;return Ae("roomId","string",t),this.serverInstanceV2.request({method:"DELETE",path:"/rooms/"+encodeURIComponent(t)}).then(function(){}).catch(function(t){throw e.logger.warn("error deleting room:",t),t})}},{key:"setReadCursorRequest",value:function(e){var t=this,n=e.roomId,r=e.position,o=e.callbacks;return this.cursorsInstance.request({method:"PUT",path:"/cursors/0/rooms/"+encodeURIComponent(n)+"/users/"+this.encodedId,json:{position:r}}).then(function(){return L(function(e){return e.resolve()},o)}).catch(function(e){t.logger.warn("error setting cursor:",e),L(function(t){return t.reject(e)},o)})}},{key:"uploadDataAttachment",value:function(e,t){var n=t.file,r=t.name,o=new FormData;return o.append("file",n,r),this.filesInstance.request({method:"POST",path:"/rooms/"+encodeURIComponent(e)+"/users/"+this.encodedId+"/files/"+encodeURIComponent(r),body:o}).then(JSON.parse)}},{key:"_uploadAttachment",value:function(e){var t=e.roomId,n=e.part,r=n.type,o=n.name,i=n.customData,a=n.file;return this.serverInstanceV6.request({method:"POST",path:"/rooms/"+encodeURIComponent(t)+"/attachments",json:{content_type:r,content_length:a.size,name:o||a.name,custom_data:i}}).then(function(e){var t=JSON.parse(e),n=t.attachment_id,o=t.upload_url;return s({method:"PUT",url:o,body:a,headers:{"content-type":r}}).then(function(){return{type:r,attachment:{id:n}}})})}},{key:"isMemberOf",value:function(e){return de(e,L(B("id"),this.rooms))}},{key:"isSubscribedTo",value:function(e){return ge(e,this.roomSubscriptions)}},{key:"decorateMessage",value:function(e){return new dt(e,this.userStore,this.roomStore,this.serverInstanceV6)}},{key:"setPropertiesFromBasicUser",value:function(e){this.avatarURL=e.avatarURL,this.createdAt=e.createdAt,this.customData=e.customData,this.name=e.name,this.updatedAt=e.updatedAt}},{key:"establishUserSubscription",value:function(){var e=this;return this.userSubscription=new at({hooks:this.hooks,userId:this.id,instance:this.serverInstanceV6,roomStore:this.roomStore,cursorStore:this.cursorStore,typingIndicators:this.typingIndicators,logger:this.logger,connectionTimeout:this.connectionTimeout,currentUser:this}),this.userSubscription.connect().then(function(t){var n=t.basicUser,r=t.basicRooms,o=t.basicCursors;return e.setPropertiesFromBasicUser(n),Promise.all([].concat(Ce(r.map(function(t){return e.roomStore.set(t)})),Ce(o.map(function(t){return e.cursorStore.set(t)}))))}).catch(function(t){throw e.logger.error("error establishing user subscription:",t),t})}},{key:"establishPresenceSubscription",value:function(){var e=this;return this.presenceSubscription=new ut({userId:this.id,instance:this.presenceInstance,logger:this.logger,connectionTimeout:this.connectionTimeout}),Promise.all([this.userStore.fetchMissingUser(this.id),this.subscribeToUserPresence(this.id),this.presenceSubscription.connect().catch(function(t){throw e.logger.warn("error establishing presence subscription:",t),t})])}},{key:"subscribeToUserPresence",value:function(e){if(this.userPresenceSubscriptions[e])return Promise.resolve();var t=new ct({hooks:this.hooks,userId:e,instance:this.presenceInstance,userStore:this.userStore,roomStore:this.roomStore,presenceStore:this.presenceStore,logger:this.logger,connectionTimeout:this.connectionTimeout});return this.userPresenceSubscriptions[e]=t,t.connect()}},{key:"enablePushNotifications",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.onClick,r=t.serviceWorkerRegistration,o=t.showNotificationsTabOpen,i=void 0===o||o,s=t.showNotificationsTabClosed,a=void 0===s||s,u=t._Notification,c=void 0===u?Notification:u,h=t._visibilityStateOverride;try{if(n&&Ae("onClick","function",n),Ae("showNotificationsTabOpen","boolean",i),Ae("showNotificationsTabClosed","boolean",a),!this._hasPermissionToSendNotifications())return Promise.reject("Failed to get permission to send notifications");var l=[];return i&&l.push(this._enableTabOpenNotifications({onClick:n,Notification:c,visibilityStateOverride:h})),a?l.push(this._enableTabClosedNotifications(r)):l.push(this._disableTabClosedNotifications()),Promise.all(l).catch(function(t){return e.logger.warn("Chatkit error when enabling push notifications:",t),Promise.reject("Chatkit error when enabling push notifications: "+t)})}catch(e){return this.logger.warn("Chatkit error when enabling push notifications:",e),Promise.reject("Chatkit error when enabling push notifications: "+e)}}},{key:"disablePushNotifications",value:function(){var e=this;return this._disableTabClosedNotifications().then(function(){return e._disableTabOpenNotifications()})}},{key:"_hasPermissionToSendNotifications",value:function(){return Notification.requestPermission().then(function(e){return"granted"===e})}},{key:"_enableTabOpenNotifications",value:function(e){var t=e.onClick,n=e.Notification,r=e.visibilityStateOverride,o=new vt({onNotificationHook:function(e){return function(e){var t=e.notification,n=e.data,r=e.onClick,o=e.Notification;"hidden"===(e.visibilityStateOverride||document.visibilityState)&&(new o(t.title||"",{body:t.body||"",icon:t.icon,data:Object.assign(n,{pusher:{deep_link:t.deep_link}})}).onclick=function(e){e.preventDefault(),window.focus(),r&&r(e.target.data.chatkit),e.target.close()})}({notification:e.notification,data:e.data,onClick:t,Notification:n,visibilityStateOverride:r})},userId:this.id,instance:this.pushNotificationsInstance,logger:this.logger,connectionTimeout:this.connectionTimeout});return this.notificationSubscription=o,o.connect()}},{key:"_disableTabOpenNotifications",value:function(){this.notificationSubscription.cancel()}},{key:"_enableTabClosedNotifications",value:function(e){var t=this,n=function(e){return t.beamsTokenProviderInstance.request({method:"GET",path:"/beams-tokens?user_id="+encodeURIComponent(e)}).then(JSON.parse).catch(function(e){return Promise.reject("Internal error: "+e.statusCode+" status code, info: "+e.info.error_description)})};return this.beamsInstanceInitFn({serviceWorkerRegistration:e}).then(function(e){return e.start()}).then(function(e){return e.setUserId(t.id,{fetchToken:n})})}},{key:"_disableTabClosedNotifications",value:function(){return this.beamsInstanceInitFn().then(function(e){return e.stop()})}},{key:"disconnect",value:function(){this.userSubscription.cancel(),this.presenceSubscription.cancel(),this.notificationSubscription&&this.notificationSubscription.cancel(),pe(function(e){return e.cancel()},this.roomSubscriptions),pe(function(e){return e.cancel()},this.userPresenceSubscriptions)}},{key:"rooms",get:function(){return F(this.roomStore.snapshot())}},{key:"users",get:function(){return F(this.userStore.snapshot())}}]),e}(),bt=function(e){var t=e.file,n=e.name;return void 0!==t&&void 0!==n&&(Ae("attachment.file","object",t),Ae("attachment.name","string",n),!0)},yt=function(e){var t=e.link,n=e.type;return void 0!==t&&void 0!==n&&(Ae("attachment.link","string",t),Ae("attachment.type","string",n),!0)},St="1.14.1";var wt=function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}};var kt=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)};var It=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var Et=function(e){return wt(e)||kt(e)||It()};var Rt=function(e,t){return e(t={exports:{}},t.exports),t.exports}(function(e){var t=function(e){var t,n=Object.prototype,r=n.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",a=o.toStringTag||"@@toStringTag";function u(e,t,n,r){var o=t&&t.prototype instanceof g?t:g,i=Object.create(o.prototype),s=new _(r||[]);return i._invoke=function(e,t,n){var r=h;return function(o,i){if(r===d)throw new Error("Generator is already running");if(r===f){if("throw"===o)throw i;return P()}for(n.method=o,n.arg=i;;){var s=n.delegate;if(s){var a=E(s,n);if(a){if(a===p)continue;return a}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===h)throw r=f,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=d;var u=c(e,t,n);if("normal"===u.type){if(r=n.done?f:l,u.arg===p)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r=f,n.method="throw",n.arg=u.arg)}}}(e,n,s),i}function c(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var h="suspendedStart",l="suspendedYield",d="executing",f="completed",p={};function g(){}function v(){}function m(){}var b={};b[i]=function(){return this};var y=Object.getPrototypeOf,S=y&&y(y(O([])));S&&S!==n&&r.call(S,i)&&(b=S);var w=m.prototype=g.prototype=Object.create(b);function k(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function I(e){var t;this._invoke=function(n,o){function i(){return new Promise(function(t,i){!function t(n,o,i,s){var a=c(e[n],e,o);if("throw"!==a.type){var u=a.arg,h=u.value;return h&&"object"==typeof h&&r.call(h,"__await")?Promise.resolve(h.__await).then(function(e){t("next",e,i,s)},function(e){t("throw",e,i,s)}):Promise.resolve(h).then(function(e){u.value=e,i(u)},function(e){return t("throw",e,i,s)})}s(a.arg)}(n,o,t,i)})}return t=t?t.then(i,i):i()}}function E(e,n){var r=e.iterator[n.method];if(r===t){if(n.delegate=null,"throw"===n.method){if(e.iterator.return&&(n.method="return",n.arg=t,E(e,n),"throw"===n.method))return p;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var o=c(r,e.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,p;var i=o.arg;return i?i.done?(n[e.resultName]=i.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,p):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,p)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function O(e){if(e){var n=e[i];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,s=function n(){for(;++o<e.length;)if(r.call(e,o))return n.value=e[o],n.done=!1,n;return n.value=t,n.done=!0,n};return s.next=s}}return{next:P}}function P(){return{value:t,done:!0}}return v.prototype=w.constructor=m,m.constructor=v,m[a]=v.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,a in e||(e[a]="GeneratorFunction")),e.prototype=Object.create(w),e},e.awrap=function(e){return{__await:e}},k(I.prototype),I.prototype[s]=function(){return this},e.AsyncIterator=I,e.async=function(t,n,r,o){var i=new I(u(t,n,r,o));return e.isGeneratorFunction(n)?i:i.next().then(function(e){return e.done?e.value:i.next()})},k(w),w[a]="Generator",w[i]=function(){return this},w.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(T),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function o(r,o){return a.type="throw",a.arg=e,n.next=r,o&&(n.method="next",n.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var u=r.call(s,"catchLoc"),c=r.call(s,"finallyLoc");if(u&&c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(u){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,p):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),T(n),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;T(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:O(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),p}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}});var Tt=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function _t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ot=function(e,t,n){return t&&_t(e.prototype,t),n&&_t(e,n),e};function Pt(e,t,n,r,o,i,s){try{var a=e[i](s),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(r,o)}var Nt=function(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function s(e){Pt(i,r,o,s,a,"next",e)}function a(e){Pt(i,r,o,s,a,"throw",e)}s(void 0)})}};var Ut=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e};function xt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function Ct(e){var t=e.method,n=e.path,r=e.body,o=void 0===r?null:r,i=e.headers,s=void 0===i?{}:i,a={method:t,headers:s};return null!==o&&(a.body=JSON.stringify(o),a.headers=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xt(Object(n),!0).forEach(function(t){Ut(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xt(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({"Content-Type":"application/json"},s)),fetch(n,a).then(function(){var e=Nt(Rt.mark(function e(t){return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.ok){e.next=3;break}return e.next=3,Mt(t);case 3:return e.prev=3,e.next=6,t.json();case 6:return e.abrupt("return",e.sent);case 9:return e.prev=9,e.t0=e.catch(3),e.abrupt("return",null);case 12:case"end":return e.stop()}},e,null,[[3,9]])}));return function(t){return e.apply(this,arguments)}}())}function Mt(e){return At.apply(this,arguments)}function At(){return(At=Nt(Rt.mark(function e(t){var n,r,o,i,s,a;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.json();case 3:r=e.sent,o=r.error,i=void 0===o?"Unknown error":o,s=r.description,a=void 0===s?"No description":s,n="Unexpected status code ".concat(t.status,": ").concat(i,", ").concat(a),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),n="Unexpected status code ".concat(t.status,": Cannot parse error response");case 14:throw new Error(n);case 15:case"end":return e.stop()}},e,null,[[0,11]])}))).apply(this,arguments)}var jt=function(){function e(t){Tt(this,e),this._instanceId=t,this._dbConn=null}return Ot(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,n){var r=indexedDB.open(e._dbName);r.onsuccess=function(n){var r=n.target.result;e._dbConn=r,e._readState().then(function(t){return null===t?e.clear():Promise.resolve()}).then(t)},r.onupgradeneeded=function(e){e.target.result.createObjectStore("beams",{keyPath:"instance_id"})},r.onerror=function(e){var t=new Error("Database error: ".concat(e.target.error));n(t)}})}},{key:"clear",value:function(){return this._writeState({instance_id:this._instanceId,device_id:null,token:null,user_id:null})}},{key:"_readState",value:function(){var e=this;if(!this.isConnected)throw new Error("Cannot read value: DeviceStateStore not connected to IndexedDB");return new Promise(function(t,n){var r=e._dbConn.transaction("beams").objectStore("beams").get(e._instanceId);r.onsuccess=function(e){var n=e.target.result;n||t(null),t(n)},r.onerror=function(e){n(e.target.error)}})}},{key:"_readProperty",value:function(){var e=Nt(Rt.mark(function e(t){var n;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._readState();case 2:if(null!==(n=e.sent)){e.next=5;break}return e.abrupt("return",null);case 5:return e.abrupt("return",n[t]||null);case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_writeState",value:function(e){var t=this;if(!this.isConnected)throw new Error("Cannot write value: DeviceStateStore not connected to IndexedDB");return new Promise(function(n,r){var o=t._dbConn.transaction("beams","readwrite").objectStore("beams").put(e);o.onsuccess=function(e){n()},o.onerror=function(e){r(e.target.error)}})}},{key:"_writeProperty",value:function(){var e=Nt(Rt.mark(function e(t,n){var r;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._readState();case 2:return(r=e.sent)[t]=n,e.next=6,this._writeState(r);case 6:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"getToken",value:function(){return this._readProperty("token")}},{key:"setToken",value:function(e){return this._writeProperty("token",e)}},{key:"getDeviceId",value:function(){return this._readProperty("device_id")}},{key:"setDeviceId",value:function(e){return this._writeProperty("device_id",e)}},{key:"getUserId",value:function(){return this._readProperty("user_id")}},{key:"setUserId",value:function(e){return this._writeProperty("user_id",e)}},{key:"getLastSeenSdkVersion",value:function(){return this._readProperty("last_seen_sdk_version")}},{key:"setLastSeenSdkVersion",value:function(e){return this._writeProperty("last_seen_sdk_version",e)}},{key:"getLastSeenUserAgent",value:function(){return this._readProperty("last_seen_user_agent")}},{key:"setLastSeenUserAgent",value:function(e){return this._writeProperty("last_seen_user_agent",e)}},{key:"_dbName",get:function(){return"beams-".concat(this._instanceId)}},{key:"isConnected",get:function(){return null!==this._dbConn}}]),e}(),Dt="/service-worker.js?pusherBeamsWebSDKVersion=".concat("0.9.2");function Lt(){return(Lt=Nt(Rt.mark(function e(t){var n,r,o,i,s,a,u,c,h,l;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}throw new Error("Config object required");case 2:if(n=t.instanceId,r=t.endpointOverride,o=void 0===r?null:r,i=t.serviceWorkerRegistration,s=void 0===i?null:i,void 0!==n){e.next=5;break}throw new Error("Instance ID is required");case 5:if("string"==typeof n){e.next=7;break}throw new Error("Instance ID must be a string");case 7:if(0!==n.length){e.next=9;break}throw new Error("Instance ID cannot be empty");case 9:if(window.indexedDB){e.next=11;break}throw new Error("Pusher Beams does not support this browser version (IndexedDB not supported)");case 11:if("showNotification"in ServiceWorkerRegistration.prototype){e.next=13;break}throw new Error("Pusher Beams does not support this browser version (ServiceWorkerRegistration not supported)");case 13:if("PushManager"in window){e.next=15;break}throw new Error("Pusher Beams does not support this browser version (PushManager not supported)");case 15:return a=new jt(n),e.next=18,a.connect();case 18:return e.next=20,a.getDeviceId();case 20:return u=e.sent,e.next=23,a.getToken();case 23:return c=e.sent,e.next=26,a.getUserId();case 26:if(h=e.sent,l=new qt({instanceId:n,deviceId:u,token:c,userId:h,serviceWorkerRegistration:s,deviceStateStore:a,endpointOverride:o}),!(null!==u)){e.next=37;break}return e.prev=30,e.next=33,l._updateDeviceMetadata();case 33:e.next=37;break;case 35:e.prev=35,e.t0=e.catch(30);case 37:return e.abrupt("return",l);case 38:case"end":return e.stop()}},e,null,[[30,35]])}))).apply(this,arguments)}var qt=function(){function e(t){var n=t.instanceId,r=t.deviceId,o=t.token,i=t.userId,s=t.serviceWorkerRegistration,a=t.deviceStateStore,u=t.endpointOverride,c=void 0===u?null:u;if(Tt(this,e),this.instanceId=n,this.deviceId=r,this.token=o,this.userId=i,this._deviceStateStore=a,this._endpoint=c,s){var h=s.scope;if(!window.location.href.startsWith(h))throw new Error("Could not initialize Pusher web push: current page not in serviceWorkerRegistration scope (".concat(h,")"))}this._serviceWorkerRegistration=s}return Ot(e,[{key:"start",value:function(){var e=Nt(Rt.mark(function e(){var t,n,r,o;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Bt()){e.next=3;break}return console.warn("Pusher Web Push Notifications only supports Google Chrome (whilst in Beta)"),e.abrupt("return",this);case 3:if(null===this.deviceId){e.next=5;break}return e.abrupt("return",this);case 5:return e.next=7,this._getPublicKey();case 7:return t=e.sent,n=t.vapidPublicKey,e.next=11,this._getPushToken(n);case 11:return r=e.sent,e.next=14,this._registerDevice(r);case 14:return o=e.sent,e.next=17,this._deviceStateStore.setToken(r);case 17:return e.next=19,this._deviceStateStore.setDeviceId(o);case 19:return e.next=21,this._deviceStateStore.setLastSeenSdkVersion("0.9.2");case 21:return e.next=23,this._deviceStateStore.setLastSeenUserAgent(window.navigator.userAgent);case 23:return this.token=r,this.deviceId=o,e.abrupt("return",this);case 26:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"setUserId",value:function(){var e=Nt(Rt.mark(function e(t,n){var r,o,i,s,a;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Bt()){e.next=3;break}return console.warn("Pusher Web Push Notifications only supports Google Chrome (whilst in Beta)"),e.abrupt("return");case 3:if(null!==this.deviceId){e.next=6;break}return r=new Error(".start must be called before .setUserId"),e.abrupt("return",Promise.reject(r));case 6:if("string"==typeof t){e.next=8;break}throw new Error("User ID must be a string (was ".concat(t,")"));case 8:if(""!==t){e.next=10;break}throw new Error("User ID cannot be the empty string");case 10:if(null===this.userId||this.userId===t){e.next=12;break}throw new Error("Changing the `userId` is not allowed.");case 12:return o="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(this.deviceId,"/user"),e.next=15,n.fetchToken(t);case 15:return i=e.sent,s=i.token,a={method:"PUT",path:o,headers:{Authorization:"Bearer ".concat(s)}},e.next=20,Ct(a);case 20:return this.userId=t,e.abrupt("return",this._deviceStateStore.setUserId(t));case 22:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=Nt(Rt.mark(function e(){return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Bt()){e.next=3;break}return console.warn("Pusher Web Push Notifications only supports Google Chrome (whilst in Beta)"),e.abrupt("return");case 3:if(null!==this.deviceId){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,this._deleteDevice();case 7:return e.next=9,this._deviceStateStore.clear();case 9:this.deviceId=null,this.token=null,this.userId=null;case 12:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"clearAllState",value:function(){var e=Nt(Rt.mark(function e(){return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Bt()){e.next=3;break}return console.warn("Pusher Web Push Notifications only supports Google Chrome (whilst in Beta)"),e.abrupt("return");case 3:return e.next=5,this.stop();case 5:return e.next=7,this.start();case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_getPublicKey",value:function(){var e=Nt(Rt.mark(function e(){var t,n;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/web-vapid-public-key"),n={method:"GET",path:t},e.abrupt("return",Ct(n));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_getPushToken",value:function(){var e=Nt(Rt.mark(function e(t){var n,r,o;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!this._serviceWorkerRegistration){e.next=5;break}n=this._serviceWorkerRegistration,e.next=15;break;case 5:return e.next=7,fetch(Dt);case 7:if(r=e.sent,200===r.status){e.next=11;break}throw new Error("Cannot start SDK, service worker missing: No file found at /service-worker.js");case 11:return window.navigator.serviceWorker.register(Dt,{updateViaCache:"none"}),e.next=14,window.navigator.serviceWorker.ready;case 14:n=e.sent;case 15:return e.next=17,n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:(i=t,void 0,void 0,void 0,s="=".repeat((4-i.length%4)%4),a=(i+s).replace(/-/g,"+").replace(/_/g,"/"),u=window.atob(a),Uint8Array.from(Et(u).map(function(e){return e.charCodeAt(0)})))});case 17:return o=e.sent,e.abrupt("return",btoa(JSON.stringify(o)));case 21:return e.prev=21,e.t0=e.catch(0),e.abrupt("return",Promise.reject(e.t0));case 24:case"end":return e.stop()}var i,s,a,u},e,this,[[0,21]])}));return function(t){return e.apply(this,arguments)}}()},{key:"_registerDevice",value:function(){var e=Nt(Rt.mark(function e(t){var n,r,o;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web"),r={method:"POST",path:n,body:{token:t,metadata:{sdkVersion:"0.9.2"}}},e.next=5,Ct(r);case 5:return o=e.sent,e.abrupt("return",o.id);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_deleteDevice",value:function(){var e=Nt(Rt.mark(function e(){var t,n;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(encodeURIComponent(this.deviceId)),n={method:"DELETE",path:t},e.next=4,Ct(n);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_updateDeviceMetadata",value:function(){var e=Nt(Rt.mark(function e(){var t,n,r,o,i;return Rt.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=window.navigator.userAgent,e.next=3,this._deviceStateStore.getLastSeenUserAgent();case 3:return n=e.sent,e.next=6,this._deviceStateStore.getLastSeenSdkVersion();case 6:if(r=e.sent,t!==n||"0.9.2"!==r){e.next=9;break}return e.abrupt("return");case 9:return o="".concat(this._baseURL,"/device_api/v1/instances/").concat(encodeURIComponent(this.instanceId),"/devices/web/").concat(this.deviceId,"/metadata"),i={method:"PUT",path:o,body:{sdkVersion:"0.9.2"}},e.next=14,Ct(i);case 14:return e.next=16,this._deviceStateStore.setLastSeenSdkVersion("0.9.2");case 16:return e.next=18,this._deviceStateStore.setLastSeenUserAgent(t);case 18:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_baseURL",get:function(){return null!==this._endpoint?this._endpoint:"https://".concat(this.instanceId,".pushnotifications.pusher.com")}}]),e}();function Bt(){var e=window.navigator,t=e.vendor,n=null!==window.chrome&&void 0!==window.chrome,r=e.userAgent.indexOf("OPR")>-1,o=e.userAgent.indexOf("Edge")>-1;return n&&"Google Inc."===t&&!o&&!r||r}return{TokenProvider:He,ChatManager:function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.instanceLocator,s=t.tokenProvider,a=t.userId,u=Ue(t,["instanceLocator","tokenProvider","userId"]);Oe(this,e),Ae("instanceLocator","string",n),Ae("tokenProvider","object",s),Ae("tokenProvider.fetchToken","function",s.fetchToken),Ae("userId","string",a);var c=Ee(":",n),h=xe(c,3),l=h[0],d=h[1],f=h[2];if(!l||!d||!f)throw new TypeError("expected instanceLocator to be of the format x:y:z, but was "+n);var p=u.baseClient||new r({host:d+"."+o,logger:u.logger,sdkProduct:"chatkit",sdkLanguage:u.sdkLanguage,sdkVersion:St});"function"==typeof s.setUserId&&s.setUserId(a);var g={client:p,locator:n,logger:u.logger,tokenProvider:s};this.serverInstanceV2=new i(Ne({serviceName:"chatkit",serviceVersion:"v2"},g)),this.serverInstanceV6=new i(Ne({serviceName:"chatkit",serviceVersion:"v6"},g)),this.filesInstance=new i(Ne({serviceName:"chatkit_files",serviceVersion:"v1"},g)),this.cursorsInstance=new i(Ne({serviceName:"chatkit_cursors",serviceVersion:"v2"},g)),this.presenceInstance=new i(Ne({serviceName:"chatkit_presence",serviceVersion:"v2"},g)),this.beamsTokenProviderInstance=new i(Ne({serviceName:"chatkit_beams_token_provider",serviceVersion:"v1"},g)),this.pushNotificationsInstance=new i(Ne({serviceName:"chatkit_push_notifications",serviceVersion:"v1"},g)),this.beamsInstanceInitFn=u.beamsInstanceInitFn||function(e){return function(e){return Lt.apply(this,arguments)}(Ne({instanceId:f},e))},this.logger=this.serverInstanceV6.logger,this.userId=a,this.connectionTimeout=u.connectionTimeout||Ze,this.connect=this.connect.bind(this),this.disconnect=this.disconnect.bind(this)}return Pe(e,[{key:"connect",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};qe("hooks","function",t);var n=new mt({hooks:t,id:this.userId,serverInstanceV2:this.serverInstanceV2,serverInstanceV6:this.serverInstanceV6,filesInstance:this.filesInstance,cursorsInstance:this.cursorsInstance,presenceInstance:this.presenceInstance,beamsTokenProviderInstance:this.beamsTokenProviderInstance,pushNotificationsInstance:this.pushNotificationsInstance,beamsInstanceInitFn:this.beamsInstanceInitFn,connectionTimeout:this.connectionTimeout});return Promise.all([n.establishUserSubscription(),n.establishPresenceSubscription()]).then(function(){return e.currentUser=n,n})}},{key:"disconnect",value:function(){this.currentUser&&this.currentUser.disconnect()}},{key:"disablePushNotifications",value:function(){return this.currentUser?this.currentUser.disablePushNotifications().catch(function(e){return Promise.reject("Chatkit error when disabling push notifications: "+e.message)}):Promise.reject("Cannot disable notifications until .connect is called")}}]),e}()}});
